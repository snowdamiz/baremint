---
phase: 02-bonding-curve-smart-contract
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Anchor.toml
  - Cargo.toml
  - programs/baremint/Cargo.toml
  - programs/baremint/Xargo.toml
  - programs/baremint/src/lib.rs
  - programs/baremint/src/state/mod.rs
  - programs/baremint/src/state/global_config.rs
  - programs/baremint/src/state/bonding_curve.rs
  - programs/baremint/src/state/vesting.rs
  - programs/baremint/src/state/creator_profile.rs
  - programs/baremint/src/errors.rs
  - programs/baremint/src/instructions/mod.rs
  - programs/baremint/src/instructions/initialize.rs
  - tsconfig.json
  - package.json
autonomous: true

must_haves:
  truths:
    - "Anchor project builds without errors"
    - "GlobalConfig PDA can be initialized with correct fee and vesting parameters"
    - "All state account structs compile with correct space calculations"
  artifacts:
    - path: "programs/baremint/src/state/global_config.rs"
      provides: "GlobalConfig account struct with fee, vesting, and cooldown params"
      contains: "pub struct GlobalConfig"
    - path: "programs/baremint/src/state/bonding_curve.rs"
      provides: "BondingCurve account struct with virtual/real reserves"
      contains: "pub struct BondingCurve"
    - path: "programs/baremint/src/state/vesting.rs"
      provides: "VestingAccount struct with cliff, duration, claimed tracking"
      contains: "pub struct VestingAccount"
    - path: "programs/baremint/src/state/creator_profile.rs"
      provides: "CreatorProfile PDA for 90-day cooldown enforcement"
      contains: "pub struct CreatorProfile"
    - path: "programs/baremint/src/errors.rs"
      provides: "Custom error codes for all failure modes"
      contains: "pub enum ErrorCode"
    - path: "programs/baremint/src/instructions/initialize.rs"
      provides: "Initialize instruction setting up GlobalConfig"
      contains: "pub fn initialize"
  key_links:
    - from: "programs/baremint/src/lib.rs"
      to: "programs/baremint/src/instructions/mod.rs"
      via: "module declaration and instruction dispatch"
      pattern: "mod instructions"
    - from: "programs/baremint/src/instructions/initialize.rs"
      to: "programs/baremint/src/state/global_config.rs"
      via: "Account<GlobalConfig> in context struct"
      pattern: "Account.*GlobalConfig"
---

<objective>
Scaffold the Anchor project and implement all state account structures plus the GlobalConfig initialization instruction.

Purpose: Establishes the on-chain program foundation -- project structure, all account types, error codes, and the first instruction. Every subsequent plan builds on these types and project structure.
Output: A building Anchor program with all state accounts defined and GlobalConfig initializable.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bonding-curve-smart-contract/02-CONTEXT.md
@.planning/phases/02-bonding-curve-smart-contract/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Anchor project with all state accounts and error codes</name>
  <files>
    Anchor.toml
    Cargo.toml
    programs/baremint/Cargo.toml
    programs/baremint/Xargo.toml
    programs/baremint/src/lib.rs
    programs/baremint/src/state/mod.rs
    programs/baremint/src/state/global_config.rs
    programs/baremint/src/state/bonding_curve.rs
    programs/baremint/src/state/vesting.rs
    programs/baremint/src/state/creator_profile.rs
    programs/baremint/src/errors.rs
    tsconfig.json
    package.json
  </files>
  <action>
    1. Initialize Anchor project structure. This is NOT a standalone Anchor workspace -- this is ADDING an Anchor program to an existing Next.js project. The existing package.json already has dependencies. Create a workspace Cargo.toml at root, programs/baremint/ directory with its own Cargo.toml, and Anchor.toml at project root.

    2. Anchor.toml configuration:
       - programs.localnet: baremint = "YOUR_PROGRAM_ID" (generate a keypair with `anchor keys list` after scaffold, or use a placeholder and update)
       - provider.cluster = "localnet"
       - provider.wallet = "~/.config/solana/id.json"
       - test.startup_wait = 5000
       - test.shutdown_wait = 2000
       - [scripts] test = "npx jest --forceExit"

    3. programs/baremint/Cargo.toml:
       - anchor-lang = "0.32.1" with features = ["init-if-needed"]
       - anchor-spl = "0.32.1" with features = ["token"]
       - Enable overflow-checks = true in [profile.release]

    4. Create all state account structs per RESEARCH.md specifications:

       GlobalConfig (state/global_config.rs):
       - authority: Pubkey (platform admin)
       - fee_bps: u16 (500 = 5% total)
       - platform_fee_bps: u16 (250 = 2.5%)
       - creator_fee_bps: u16 (250 = 2.5%)
       - initial_virtual_token_reserves: u64
       - initial_virtual_sol_reserves: u64
       - vesting_cliff_seconds: i64 (2_592_000 = 30 days)
       - vesting_duration_seconds: i64 (5_184_000 = 60 days)
       - vesting_claim_interval_seconds: i64 (604_800 = 7 days)
       - launch_cooldown_seconds: i64 (7_776_000 = 90 days)
       - creator_allocation_bps: u16 (1000 = 10%)
       - bump: u8
       - Use #[account] and #[derive(InitSpace)]

       BondingCurve (state/bonding_curve.rs):
       - token_mint: Pubkey
       - creator: Pubkey
       - virtual_token_reserves: u64
       - virtual_sol_reserves: u64
       - real_token_reserves: u64
       - real_sol_reserves: u64
       - token_total_supply: u64
       - burn_sol_price: u64 (SOL-denominated burn cost, set by creator -- 0 means burns disabled)
       - bump: u8
       - Use #[account] and #[derive(InitSpace)]
       - NOTE: Do NOT store fee_bps or last_launch_timestamp on BondingCurve -- fees come from GlobalConfig, cooldown is on CreatorProfile

       VestingAccount (state/vesting.rs):
       - creator: Pubkey
       - token_mint: Pubkey
       - total_allocation: u64
       - claimed_amount: u64
       - start_timestamp: i64
       - is_revoked: bool
       - bump: u8
       - Use #[account] and #[derive(InitSpace)]

       CreatorProfile (state/creator_profile.rs):
       - creator: Pubkey
       - last_token_launch_timestamp: i64 (0 means never launched)
       - tokens_launched: u32 (counter for analytics)
       - bump: u8
       - Seeds: [b"creator_profile", creator.key().as_ref()]
       - Use #[account] and #[derive(InitSpace)]

    5. Create errors.rs with comprehensive ErrorCode enum:
       - Unauthorized
       - MathOverflow
       - SlippageExceeded
       - InsufficientFunds
       - InsufficientTokens
       - InsufficientReserves
       - CooldownNotElapsed (90-day cooldown)
       - VestingCliffNotReached
       - VestingFullyClaimed
       - VestingRevoked
       - BurnDisabled (burn_sol_price == 0)
       - InvalidFeeConfiguration
       - InvalidReserveConfiguration
       - TokenSupplyMismatch

    6. Create lib.rs with declare_id!, mod state, mod errors, mod instructions, and program module stub that dispatches to initialize. Use `use instructions::*;` pattern.

    7. Install TypeScript test dependencies into existing package.json:
       ```
       npm install --save-dev @coral-xyz/anchor @solana/web3.js anchor-bankrun solana-bankrun
       ```
       Also ensure jest, @types/jest, ts-jest are present (add if missing).

    8. Add/update tsconfig.json to include "tests/**/*" in the includes if not already present (do NOT break existing Next.js tsconfig -- you may need a separate tsconfig.test.json or extend the existing one).
  </action>
  <verify>
    Run `cd programs/baremint && cargo check` -- must compile without errors.
    Run `anchor build` from project root -- must produce a .so file in target/deploy/.
    Run `anchor keys list` -- must output a program ID.
  </verify>
  <done>
    Anchor project compiles. All four state account structs (GlobalConfig, BondingCurve, VestingAccount, CreatorProfile) are defined with correct fields and InitSpace. Error codes cover all planned failure modes. TypeScript test dependencies installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement initialize instruction for GlobalConfig</name>
  <files>
    programs/baremint/src/instructions/mod.rs
    programs/baremint/src/instructions/initialize.rs
    programs/baremint/src/lib.rs
  </files>
  <action>
    1. Create instructions/initialize.rs with:

       Context struct `Initialize`:
       - authority: Signer (payer, mut)
       - global_config: Account<GlobalConfig> with init, payer = authority, space = 8 + GlobalConfig::INIT_SPACE, seeds = [b"global_config"], bump
       - platform_vault: SystemAccount (PDA, seeds = [b"platform_vault"], used as SOL vault for platform fees -- does NOT need init, just validated via seeds)
       - system_program: Program<System>

       Handler function `initialize`:
       - Accepts parameters for all configurable values:
         - fee_bps: u16
         - platform_fee_bps: u16
         - creator_fee_bps: u16
         - initial_virtual_token_reserves: u64
         - initial_virtual_sol_reserves: u64
       - Validates fee_bps == platform_fee_bps + creator_fee_bps, return InvalidFeeConfiguration if not
       - Validates fee_bps <= 1000 (max 10%), return InvalidFeeConfiguration if exceeded
       - Validates initial_virtual_token_reserves > 0 and initial_virtual_sol_reserves > 0
       - Sets GlobalConfig fields with hardcoded vesting/cooldown values:
         - vesting_cliff_seconds = 2_592_000 (30 days)
         - vesting_duration_seconds = 5_184_000 (60 days)
         - vesting_claim_interval_seconds = 604_800 (7 days)
         - launch_cooldown_seconds = 7_776_000 (90 days)
         - creator_allocation_bps = 1000 (10%)
       - Sets bump from ctx.bumps.global_config
       - Sets authority to ctx.accounts.authority.key()

    2. Wire up in instructions/mod.rs: pub mod initialize; pub use initialize::*;

    3. Wire up in lib.rs program module:
       ```rust
       pub fn initialize(ctx: Context<Initialize>, fee_bps: u16, platform_fee_bps: u16, creator_fee_bps: u16, initial_virtual_token_reserves: u64, initial_virtual_sol_reserves: u64) -> Result<()> {
           instructions::initialize::handler(ctx, fee_bps, platform_fee_bps, creator_fee_bps, initial_virtual_token_reserves, initial_virtual_sol_reserves)
       }
       ```

    4. Run `anchor build` to verify everything compiles.

    5. Update the program ID: After first build, run `anchor keys list`, copy the program ID, update declare_id! in lib.rs AND the program ID in Anchor.toml. Rebuild.
  </action>
  <verify>
    `anchor build` succeeds after program ID update.
    The IDL file at target/idl/baremint.json contains the initialize instruction with all expected parameters.
    `grep -c "initialize" target/idl/baremint.json` returns at least 1.
  </verify>
  <done>
    GlobalConfig can be initialized via the `initialize` instruction. Fee validation prevents misconfiguration. Program ID is set correctly in both lib.rs and Anchor.toml. IDL is generated with the initialize instruction.
  </done>
</task>

</tasks>

<verification>
- `anchor build` completes without errors
- `anchor keys list` shows the program ID matching declare_id! in lib.rs
- target/idl/baremint.json exists and contains initialize instruction
- All state structs compile with #[derive(InitSpace)]
- Error enum has all planned error codes
</verification>

<success_criteria>
- Anchor project builds successfully in the existing Next.js project
- All 4 state account structs defined with correct fields
- GlobalConfig initialize instruction works with fee validation
- TypeScript test dependencies installed
- Program ID correctly configured
</success_criteria>

<output>
After completion, create `.planning/phases/02-bonding-curve-smart-contract/02-01-SUMMARY.md`
</output>
