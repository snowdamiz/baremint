---
phase: 07-burn-to-unlock-premium-content
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - components/content/unlock-dialog.tsx
  - components/content/post-composer.tsx
  - components/content/post-feed.tsx
  - components/content/post-card.tsx
autonomous: true

must_haves:
  truths:
    - "Viewer sees burn cost in tokens and fee breakdown before confirming"
    - "Burn button executes the transaction and shows success/failure feedback"
    - "Content unlocks immediately after successful burn (no page refresh needed)"
    - "Creator sees informational burn cost when selecting burn_gated access level"
    - "No mention of SOL return anywhere in the burn UI"
  artifacts:
    - path: "components/content/unlock-dialog.tsx"
      provides: "Real burn-to-unlock flow with confirmation, loading, and success states"
      contains: "executeBurn"
    - path: "components/content/post-composer.tsx"
      provides: "Updated burn_gated option with burn cost info instead of threshold input"
      contains: "burn_gated"
  key_links:
    - from: "components/content/unlock-dialog.tsx"
      to: "app/api/burn/[postId]/route.ts"
      via: "fetch POST /api/burn/{postId}"
      pattern: "fetch.*api/burn"
    - from: "components/content/unlock-dialog.tsx"
      to: "app/api/burn/[postId]/route.ts"
      via: "fetch GET /api/burn/{postId} for quote"
      pattern: "fetch.*api/burn"
---

<objective>
Build the frontend burn-to-unlock experience: replace placeholder toasts with a real burn confirmation flow showing token cost and fee breakdown, update the post composer to clarify burn_gated semantics, and ensure content unlocks visually after a successful burn.

Purpose: This connects the backend burn infrastructure to the user-facing UI, completing the burn-to-unlock feature end-to-end.
Output: Functional unlock dialog with burn execution, updated composer for burn_gated posts.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-burn-to-unlock-premium-content/07-01-PLAN.md

@components/content/unlock-dialog.tsx
@components/content/post-composer.tsx
@components/content/post-feed.tsx
@components/content/post-card.tsx
@app/api/content/[postId]/media/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unlock dialog burn execution flow</name>
  <files>
    components/content/unlock-dialog.tsx
  </files>
  <action>
Rewrite the UnlockDialog component to support a real burn-to-unlock flow. The dialog has two modes based on `accessLevel`:

**For `hold_gated` posts:** Keep existing behavior (show balance progress, "Buy Tokens" button links to trade page via `window.location.href = /trade/${mintAddress}` instead of toast).

**For `burn_gated` posts:** Implement a multi-step flow:

1. **Quote step (default):** On dialog open, fetch burn quote from `GET /api/burn/${postId}`. Show:
   - "Burn Cost: X tokens" (from quote.tokensRequired, format with decimals: divide by 10^6 for display)
   - Fee breakdown: "Platform fee: X SOL, Creator fee: X SOL" (from quote, format lamports to SOL)
   - "Your balance: Y tokens" (from viewerBalance prop)
   - Warning text: "Tokens will be permanently destroyed. This action cannot be undone."
   - No mention of SOL return anywhere
   - "Burn to Unlock" button (disabled if viewer balance < tokensRequired or if quote is loading)
   - Loading spinner while quote fetches

2. **Confirming step:** After clicking "Burn to Unlock":
   - Show loading state with "Burning tokens..." message
   - Call `POST /api/burn/${postId}`
   - On success: show success state with checkmark, "Content Unlocked!" message, auto-close after 2 seconds
   - On error: show error via sonner toast, return to quote step

**Updated props interface:**

```typescript
interface UnlockDialogProps {
  isOpen: boolean;
  onClose: () => void;
  accessLevel: "hold_gated" | "burn_gated";
  requiredBalance: string;
  viewerBalance: string;
  tokenTicker: string;
  creatorTokenId: string;
  postId: string;           // NEW: needed for burn API call
  onUnlocked?: () => void;  // NEW: callback to refresh content after unlock
}
```

NOTE: `mintAddress` is NOT a prop. For burn_gated posts, `mintAddress` is fetched from the `GET /api/burn/${postId}` quote response (which includes `mintAddress` in its JSON). For hold_gated posts, the "Buy Tokens" button links to `/trade/${creatorTokenId}` using the existing `creatorTokenId` prop (the trade page accepts both token ID and mint address). Alternatively, fetch mintAddress from `/api/burn/${postId}` when needed for the trade link.

Use `useState` for dialog step: "quote" | "confirming" | "success" | "error".
Use `useEffect` to fetch burn quote when dialog opens and accessLevel is burn_gated. Store the full quote response (including `mintAddress`) in state.
Use sonner toast for error notifications (existing pattern).
Use Loader2 from lucide-react for loading spinners (existing pattern).

Format token amounts for display: divide BigInt string by 10^6 and show up to 2 decimal places.
Format SOL amounts: divide lamport string by 10^9 and show up to 4 decimal places.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no TypeScript errors.
Verify the component renders without crashing by checking no import errors.
Verify "coming soon" toast is completely removed.
Verify no mention of "SOL return" or "SOL returned" in the file.
  </verify>
  <done>
UnlockDialog shows burn quote with token cost and fee breakdown for burn_gated posts.
Clicking "Burn to Unlock" calls POST /api/burn/{postId} and shows loading/success/error states.
Hold-gated posts link to trade page instead of showing toast.
No placeholder toasts remain in the component.
  </done>
</task>

<task type="auto">
  <name>Task 2: Post composer, post card, and post feed updates for burn_gated</name>
  <files>
    components/content/post-composer.tsx
    components/content/post-feed.tsx
    components/content/post-card.tsx
  </files>
  <action>
**1. Update post-composer.tsx burn_gated behavior:**

When `burn_gated` is selected in the access level step:
- HIDE the "Minimum tokens required" input (tokenThreshold). Burn cost comes from the on-chain `burn_sol_price`, not a per-post setting.
- Instead, show an informational message: "Burn cost is determined by your token's burn price setting (set at token creation). All burn-gated posts share the same burn cost."
- When publishing with burn_gated, do NOT send tokenThreshold in the publish request body. The backend should handle burn_gated posts without tokenThreshold.
- Update the `canPublish` logic: for burn_gated, always allow publish (no threshold needed).

Update the ACCESS_LEVEL_OPTIONS description for burn_gated:
```
description: "Viewers burn tokens for permanent access (cost set by token burn price)"
```

**2. Update post-card.tsx and post-feed.tsx for content refresh after burn:**

The component tree is: `PostFeed` -> `PostCard` -> `UnlockDialog`. Here is the exact wiring:

**In `components/content/post-card.tsx`:**
- `PostCard` renders `<UnlockDialog>` on line 361 when post is locked. It already passes `creatorTokenId` and `tokenTicker`.
- Add `postId={post.id}` prop to UnlockDialog (post data is already available).
- Remove `mintAddress` from UnlockDialog props (no longer needed -- fetched from burn quote API).
- Add `onUnlocked` prop: Pass a callback from PostCard's parent (PostFeed) that re-fetches gated media for this specific post.
- Update `PostCardProps` interface to include `onUnlocked?: () => void` and forward it to UnlockDialog.

**In `components/content/post-feed.tsx`:**
- The `renderPostCard` function (line 256) renders PostCard and passes gated data.
- Add a `handlePostUnlocked` callback that re-fetches a single post's gated media:
  ```typescript
  const handlePostUnlocked = useCallback(async (postId: string) => {
    const data = await fetchGatedMedia(postId);
    if (data) {
      setGatedData((prev) => ({ ...prev, [postId]: data }));
    }
  }, []);
  ```
- The existing `fetchGatedMedia` function (line 58) already calls `GET /api/content/${postId}/media` and returns `GatedMediaResponse`. After a successful burn, calling this again will return `isLocked: false` with full presigned media URLs (because `checkContentAccess` now checks `contentUnlock` records).
- Pass `onUnlocked={() => handlePostUnlocked(postItem.id)}` to PostCard in the `renderPostCard` function.
- When `onUnlocked` fires, `setGatedData` updates the entry for that postId. React re-renders PostCard with `gated.isLocked = false` and full media URLs, showing the unlocked content immediately without page refresh.

**In UnlockDialog (from Task 1):**
- On successful burn (POST returns success), call `onUnlocked?.()` after showing the success state.
- The 2-second auto-close timeout should fire `onUnlocked` before or during close, so the content refreshes while the success message shows.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no TypeScript errors.
Verify burn_gated no longer shows tokenThreshold input in the composer.
Verify PostCard passes `postId={post.id}` and `onUnlocked` callback to UnlockDialog.
Verify PostFeed's `handlePostUnlocked` calls `fetchGatedMedia(postId)` and updates `gatedData` state.
Verify onUnlocked callback is called in UnlockDialog after successful burn.
  </verify>
  <done>
Burn-gated access level in composer hides threshold input and shows informational text.
PostCard passes postId and onUnlocked to UnlockDialog.
PostFeed provides handlePostUnlocked that re-fetches gated media for the specific post.
Successful burn triggers content refresh: gatedData updates, PostCard re-renders with isLocked=false and full media.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. UnlockDialog shows burn cost in tokens and fee breakdown for burn_gated posts
3. "Burn to Unlock" button calls POST /api/burn/{postId} and handles loading/success/error
4. No "coming soon" toast placeholders remain
5. No mention of "SOL return" in any burn UI text
6. Post composer hides tokenThreshold input for burn_gated
7. Post composer shows informational burn cost text for burn_gated
8. Content visually unlocks after successful burn without page refresh
</verification>

<success_criteria>
- Viewer can see burn cost and fee breakdown before confirming
- Viewer can execute a burn-to-unlock and see the content immediately
- Creator can publish burn_gated posts without setting a manual threshold
- The entire burn-to-unlock flow works end-to-end from UI through backend
</success_criteria>

<output>
After completion, create `.planning/phases/07-burn-to-unlock-premium-content/07-02-SUMMARY.md`
</output>
