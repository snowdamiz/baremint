---
phase: 08-creator-monetization-donations
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - lib/solana/trade.ts
  - app/trade/[token]/earnings-actions.ts
  - app/(dashboard)/dashboard/creator/earnings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Creator can claim vested tokens and see them arrive in their wallet"
    - "Creator can withdraw accumulated trade fee earnings (SOL) to their wallet"
    - "Claim button is disabled when claimable is zero or cliff not reached"
    - "Withdraw button is disabled when accrued fees are zero"
  artifacts:
    - path: "lib/solana/trade.ts"
      provides: "claim_vested and withdraw_creator_fees instruction builders"
      contains: "WITHDRAW_CREATOR_FEES_DISCRIMINATOR"
    - path: "app/trade/[token]/earnings-actions.ts"
      provides: "claimVestedTokens and withdrawCreatorFees server actions"
      exports: ["claimVestedTokens", "withdrawCreatorFees"]
    - path: "app/(dashboard)/dashboard/creator/earnings/page.tsx"
      provides: "Interactive claim and withdraw buttons"
      min_lines: 100
  key_links:
    - from: "app/(dashboard)/dashboard/creator/earnings/page.tsx"
      to: "app/trade/[token]/earnings-actions.ts"
      via: "server action calls"
      pattern: "claimVestedTokens|withdrawCreatorFees"
    - from: "app/trade/[token]/earnings-actions.ts"
      to: "lib/solana/trade.ts"
      via: "import instruction builders"
      pattern: "buildAndSendClaimVested|buildAndSendWithdrawCreatorFees"
---

<objective>
Add claim_vested and withdraw_creator_fees on-chain instruction builders, server actions, and interactive UI buttons on the earnings dashboard so creators can claim vested tokens and withdraw accumulated SOL fees.

Purpose: Creators need to actually extract their earnings, not just view them. This completes the monetization loop for trade fees and vesting.

Output: Two new instruction builders in trade.ts, two new server actions in earnings-actions.ts, interactive buttons on the earnings dashboard page.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-creator-monetization-donations/08-RESEARCH.md
@.planning/phases/08-creator-monetization-donations/08-01-SUMMARY.md

@lib/solana/trade.ts (existing buy/sell/burn builders -- add withdraw_fees and claim_vested here)
@lib/solana/bonding-curve-read.ts (readBondingCurveAccount for checking accrued fees)
@lib/solana/vesting-read.ts (readVestingAccount from 08-01)
@app/trade/[token]/earnings-actions.ts (from 08-01 -- add mutation actions here)
@app/(dashboard)/dashboard/creator/earnings/page.tsx (from 08-01 -- add interactive buttons)
@programs/baremint/src/instructions/withdraw_fees.rs (account layout: creator, bonding_curve, token_mint)
@programs/baremint/src/instructions/claim_vested.rs (account layout: creator, global_config, vesting_account, token_mint, vesting_token_account, creator_token_account, token_program)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Instruction builders for withdraw_creator_fees and claim_vested</name>
  <files>lib/solana/trade.ts</files>
  <action>
Add two new instruction builders to `lib/solana/trade.ts`, following the exact same pattern as `buildAndSendBuy` / `buildAndSendSell`:

1. **Compute Anchor discriminators:**
   - `WITHDRAW_CREATOR_FEES_DISCRIMINATOR`: First 8 bytes of `sha256("global:withdraw_creator_fees")`
   - `CLAIM_VESTED_DISCRIMINATOR`: First 8 bytes of `sha256("global:claim_vested")`
   - Use the same approach as existing BUY/SELL/BURN discriminators. If the project uses a helper, use it. Otherwise, compute using Node.js `crypto.createHash('sha256')` and hardcode the Uint8Array.

2. **buildAndSendWithdrawCreatorFees(userId: string, mintAddress: string):**
   - Get user signer via existing `getUserSigner` pattern
   - Read bonding curve to check `creatorFeesAccrued > 0`; throw if zero ("No fees to withdraw")
   - Verify signer address matches `bondingCurve.creator`; throw if mismatch ("Only the token creator can withdraw fees")
   - Derive PDAs: `bondingCurve` PDA from `["bonding_curve", mintBytes]`
   - Build instruction with discriminator-only data (no args):
     - `creator` (WRITABLE_SIGNER): signer.address
     - `bonding_curve` (WRITABLE): bondingCurve PDA
     - `token_mint` (READONLY): mint address
   - Build, sign, send via pipe pattern
   - Return `{ signature: string, amount: bigint }` where amount is the creatorFeesAccrued that was withdrawn

3. **buildAndSendClaimVested(userId: string, mintAddress: string):**
   - Get user signer
   - Read vesting account + global config to check claimable > 0; throw if zero
   - Verify signer matches `vestingAccount.creator`
   - Derive PDAs:
     - `global_config`: `["global_config"]`
     - `vesting_account`: `["vesting", mintBytes]`
     - `vesting_token_account`: `["vesting_tokens", mintBytes]`
     - `creator_token_account`: creator's ATA for the mint (use `findAssociatedTokenPda`)
   - Build instruction with discriminator-only data (no args):
     - `creator` (WRITABLE_SIGNER): signer.address
     - `global_config` (READONLY): global config PDA
     - `vesting_account` (WRITABLE): vesting PDA
     - `token_mint` (READONLY): mint address
     - `vesting_token_account` (WRITABLE): vesting tokens PDA
     - `creator_token_account` (WRITABLE): creator's ATA
     - `token_program` (READONLY): TOKEN_PROGRAM constant
   - Include `getCreateAssociatedTokenIdempotentInstructionAsync` before the claim instruction (ensure creator ATA exists)
   - Build, sign, send via pipe pattern
   - Return `{ signature: string, amount: bigint }` where amount is the claimable calculated before the transaction

Import `readVestingAccount` and `calculateClaimable` from `./vesting-read`.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify the two new functions are exported from trade.ts.
  </verify>
  <done>Both instruction builders compile, follow the established pipe pattern, and include all required accounts matching the on-chain program.</done>
</task>

<task type="auto">
  <name>Task 2: Server actions and interactive earnings dashboard</name>
  <files>app/trade/[token]/earnings-actions.ts, app/(dashboard)/dashboard/creator/earnings/page.tsx</files>
  <action>
**earnings-actions.ts** -- Add two mutation server actions alongside the existing `getCreatorEarnings`:

1. **claimVestedTokens(mintAddress: string):**
   - `"use server"` directive
   - Authenticate user, verify they own this token's creator profile
   - Call `buildAndSendClaimVested(userId, mintAddress)` from trade.ts
   - Return `{ success: true, signature, amount: string }` or `{ success: false, error: string }`
   - Wrap in try/catch, return user-friendly error messages

2. **withdrawCreatorFees(mintAddress: string):**
   - Same auth pattern
   - Call `buildAndSendWithdrawCreatorFees(userId, mintAddress)`
   - Return `{ success: true, signature, amount: string }` or `{ success: false, error: string }`

**earnings/page.tsx** -- Convert to client component wrapper around server data:

1. Create a client component `EarningsDashboard` that receives the earnings data as props
2. The page.tsx (server component) fetches data and passes to client component
3. Add interactive buttons:
   - **"Withdraw SOL" button** on the accrued fees card:
     - Disabled when `currentAccruedFees === "0"`
     - On click: call `withdrawCreatorFees(mintAddress)`, show loading state via `useTransition`, show success/error toast via sonner
     - On success: revalidate page data with `router.refresh()`
   - **"Claim Tokens" button** on the vesting card:
     - Disabled when `vesting.claimable === "0"` or `vesting.isRevoked`
     - On click: call `claimVestedTokens(mintAddress)`, show loading state, show success/error toast
     - On success: revalidate page data
4. Show transaction signature link (Solana Explorer devnet) on success toasts
5. Use the same Button component and loading patterns from the trade form
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Navigate to `/dashboard/creator/earnings` as a creator with a token. Withdraw and Claim buttons are visible and properly disabled/enabled based on data. Clicking triggers the server action (may fail on devnet if no fees/vesting, but the flow executes without client errors).
  </verify>
  <done>Creator can click "Withdraw SOL" to withdraw accrued trade fees and "Claim Tokens" to claim vested tokens, with loading states and toast feedback.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero type errors
2. `lib/solana/trade.ts` exports `buildAndSendWithdrawCreatorFees` and `buildAndSendClaimVested`
3. `app/trade/[token]/earnings-actions.ts` exports `claimVestedTokens` and `withdrawCreatorFees`
4. Earnings page shows interactive Withdraw and Claim buttons
5. Buttons are properly disabled when amounts are zero
6. Clicking buttons triggers server actions with loading state and toast feedback
</verification>

<success_criteria>
- Creator can withdraw accumulated SOL trade fees via the earnings dashboard
- Creator can claim vested tokens according to their vesting schedule
- Both operations use the established @solana/kit pipe pattern with proper PDA derivation
- UI provides clear feedback: loading state, success toast with tx signature, error toast with message
- Buttons are disabled when there is nothing to claim/withdraw
</success_criteria>

<output>
After completion, create `.planning/phases/08-creator-monetization-donations/08-02-SUMMARY.md`
</output>
