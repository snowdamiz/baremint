---
phase: 08-creator-monetization-donations
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/schema.ts
  - lib/solana/token-transfer.ts
  - app/trade/[token]/donate-actions.ts
autonomous: true

must_haves:
  truths:
    - "Donation table stores SOL and token tips with sender, recipient, amount, and tx signature"
    - "SOL tips can be sent from viewer wallet to creator wallet"
    - "Token tips can be sent from viewer ATA to creator ATA"
  artifacts:
    - path: "lib/db/schema.ts"
      provides: "donation table definition"
      contains: "export const donation"
    - path: "lib/solana/token-transfer.ts"
      provides: "SPL token transfer builder for token tips"
      exports: ["buildAndSendTokenTransfer"]
    - path: "app/trade/[token]/donate-actions.ts"
      provides: "Server actions for SOL and token donations"
      exports: ["donateSol", "donateToken", "getDonationHistory"]
  key_links:
    - from: "app/trade/[token]/donate-actions.ts"
      to: "lib/solana/transfer.ts"
      via: "import buildAndSendSolTransfer"
      pattern: "buildAndSendSolTransfer"
    - from: "app/trade/[token]/donate-actions.ts"
      to: "lib/solana/token-transfer.ts"
      via: "import buildAndSendTokenTransfer"
      pattern: "buildAndSendTokenTransfer"
    - from: "app/trade/[token]/donate-actions.ts"
      to: "lib/db/schema.ts"
      via: "insert into donation table"
      pattern: "db\\.insert\\(donation\\)"
---

<objective>
Build the donation backend: database table for tracking tips, SPL token transfer builder, and server actions for SOL and token donations from viewers to creators.

Purpose: Viewers need a way to directly support creators beyond buying tokens. This provides the data model and transaction execution for both SOL and token tips.

Output: Donation DB table, token transfer module, donate server actions.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-creator-monetization-donations/08-RESEARCH.md

@lib/db/schema.ts (existing tables: user, wallet, creatorProfile, trade, contentUnlock -- add donation table)
@lib/solana/transfer.ts (existing SOL transfer pattern -- reuse for SOL tips)
@lib/solana/trade.ts (pattern: getUserSigner, ATA creation, pipe pattern)
@app/trade/[token]/actions.ts (pattern: server actions with auth, BigInt string handling)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Donation DB table and migration</name>
  <files>lib/db/schema.ts</files>
  <action>
Add the `donation` table to `lib/db/schema.ts`, placed after the existing `contentUnlock` table (or at the end of the file, following the same section pattern):

```typescript
export const donation = pgTable("donation", {
  id: text("id").primaryKey(),       // nanoid or crypto.randomUUID
  fromUserId: text("from_user_id")
    .notNull()
    .references(() => user.id),
  toCreatorProfileId: text("to_creator_profile_id")
    .notNull()
    .references(() => creatorProfile.id),
  type: text("type").notNull(),       // "sol" | "token"
  amount: text("amount").notNull(),   // lamports (SOL) or raw token amount as BigInt string
  mintAddress: text("mint_address"),  // null for SOL tips, mint address for token tips
  txSignature: text("tx_signature").notNull(),
  status: text("status").notNull().default("confirmed"),  // optimistic: confirmed immediately
  createdAt: timestamp("created_at").notNull().defaultNow(),
});
```

After adding the table, run `npx drizzle-kit push` to sync the schema to the database. If the project uses migrations instead, run `npx drizzle-kit generate` then apply. Follow whichever pattern the existing schema changes use (check existing drizzle config).

Note: Status defaults to "confirmed" (optimistic, same pattern as withdrawals -- see research doc). No webhook confirmation for simple transfers.
  </action>
  <verify>
Run `npx drizzle-kit push` (or the project's migration command) -- schema syncs without errors. Run `npx tsc --noEmit` -- no type errors.
  </verify>
  <done>Donation table exists in the database with columns for sender, recipient, type, amount, mint, signature, status, and timestamp.</done>
</task>

<task type="auto">
  <name>Task 2: Token transfer builder and donation server actions</name>
  <files>lib/solana/token-transfer.ts, app/trade/[token]/donate-actions.ts</files>
  <action>
**token-transfer.ts** -- Create SPL token transfer builder following the `transfer.ts` pattern:

1. **buildAndSendTokenTransfer(userId: string, recipientAddress: string, mintAddress: string, amount: bigint):**
   - Get user signer via `getUserSigner` pattern (decrypt wallet key from DB)
   - Derive sender ATA: `findAssociatedTokenPda({ mint, owner: signer.address })`
   - Derive recipient ATA: `findAssociatedTokenPda({ mint, owner: recipientAddress })`
   - Build two instructions:
     a. `getCreateAssociatedTokenIdempotentInstructionAsync` for recipient ATA (ensure it exists)
     b. `getTransferInstruction` from `@solana-program/token` with `{ source: senderATA, destination: recipientATA, authority: signer, amount }`
   - Build, sign, send via pipe pattern (same as transfer.ts)
   - Return `{ signature: string }`

Import `getTransferInstruction` from `@solana-program/token` (already installed).

**donate-actions.ts** -- Server actions for donations:

1. **donateSol(mintAddress: string, amountLamports: string):**
   - `"use server"` directive
   - Authenticate user (viewer)
   - Validate `amountLamports` is a positive BigInt string
   - Look up the creator's wallet address: `creatorProfile -> user -> wallet` join where `creatorProfile.mintAddress = mintAddress`
   - Reuse `buildAndSendSolTransfer` from `lib/solana/transfer.ts` (the existing function used for withdrawals) -- pass userId, creator's wallet publicKey, and amount
   - On success, insert into `donation` table: `{ id: crypto.randomUUID(), fromUserId, toCreatorProfileId, type: "sol", amount: amountLamports, mintAddress: null, txSignature, status: "confirmed" }`
   - Return `{ success: true, signature }` or `{ success: false, error: string }`

2. **donateToken(mintAddress: string, amount: string):**
   - Same auth pattern
   - Validate `amount` is a positive BigInt string
   - Look up creator's wallet address (same join as above)
   - Call `buildAndSendTokenTransfer(userId, creatorWalletAddress, mintAddress, BigInt(amount))`
   - On success, insert into `donation` table with `type: "token"` and `mintAddress` set
   - Return `{ success: true, signature }` or `{ success: false, error: string }`

3. **getDonationHistory(mintAddress: string):**
   - Authenticate user
   - Query donation table for tips to this creator's profile, ordered by createdAt desc, limit 50
   - Join with user table to get sender names
   - Return array of `{ id, fromUserName, type, amount, txSignature, createdAt }`

Note on `buildAndSendSolTransfer`: Check the existing function signature in `lib/solana/transfer.ts`. It may be designed for withdrawals (user -> external address). For tips (user -> another user's custodial wallet), the same function should work since it just needs a destination address. If the existing function has withdrawal-specific logic (e.g., inserting into withdrawal table), either:
- Extract the pure transfer logic into a reusable helper, or
- Call it directly if it just returns the signature without side effects
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify exports: `buildAndSendTokenTransfer` from token-transfer.ts, `donateSol`, `donateToken`, `getDonationHistory` from donate-actions.ts.
  </verify>
  <done>SOL and token donation server actions work end-to-end: validate input, look up creator wallet, execute on-chain transfer, record in donation table.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero type errors
2. `donation` table exists in database
3. `lib/solana/token-transfer.ts` exports `buildAndSendTokenTransfer`
4. `app/trade/[token]/donate-actions.ts` exports `donateSol`, `donateToken`, `getDonationHistory`
5. Donation records are inserted with correct type, amount, and tx signature
</verification>

<success_criteria>
- Donation table tracks all tips with sender, recipient, type (sol/token), amount, and transaction signature
- SOL tips reuse the existing transfer pattern for sending SOL between wallets
- Token tips use SPL token transfer with idempotent ATA creation for the recipient
- Server actions validate input, authenticate users, and provide error handling
- All amounts stored as BigInt strings (no floating-point precision loss)
</success_criteria>

<output>
After completion, create `.planning/phases/08-creator-monetization-donations/08-03-SUMMARY.md`
</output>
