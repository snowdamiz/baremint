---
phase: 08-creator-monetization-donations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/solana/vesting-read.ts
  - app/trade/[token]/earnings-actions.ts
  - app/(dashboard)/dashboard/creator/earnings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Creator can view total earnings aggregated from trade fees, burns, and tips"
    - "Creator can see current accrued (unwithdrawn) fees from on-chain bonding curve"
    - "Creator can see vesting status (total, claimed, claimable, next claim date)"
  artifacts:
    - path: "lib/solana/vesting-read.ts"
      provides: "VestingAccount PDA deserialization"
      exports: ["readVestingAccount", "VestingAccountData", "calculateClaimable"]
    - path: "app/trade/[token]/earnings-actions.ts"
      provides: "Server actions for earnings data aggregation"
      exports: ["getCreatorEarnings"]
    - path: "app/(dashboard)/dashboard/creator/earnings/page.tsx"
      provides: "Earnings dashboard page with revenue breakdown"
      min_lines: 80
  key_links:
    - from: "app/(dashboard)/dashboard/creator/earnings/page.tsx"
      to: "app/trade/[token]/earnings-actions.ts"
      via: "server action call"
      pattern: "getCreatorEarnings"
    - from: "app/trade/[token]/earnings-actions.ts"
      to: "lib/solana/vesting-read.ts"
      via: "import readVestingAccount"
      pattern: "readVestingAccount"
    - from: "app/trade/[token]/earnings-actions.ts"
      to: "lib/solana/bonding-curve-read.ts"
      via: "import readBondingCurveAccount"
      pattern: "readBondingCurveAccount"
---

<objective>
Build the creator earnings dashboard: vesting account reader, SQL aggregation of revenue streams, and a server-rendered earnings page showing total revenue, current accrued fees, and vesting status.

Purpose: Creators need visibility into all revenue streams (trade fees, burn fees, tips) to understand their token economy earnings. This is the data foundation that the claim/withdraw features (08-02) build on.

Output: VestingAccount reader module, earnings aggregation server action, earnings dashboard page.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-creator-monetization-donations/08-RESEARCH.md

@lib/solana/bonding-curve-read.ts (pattern: PDA derivation + account deserialization)
@lib/solana/trade.ts (pattern: PROGRAM_ID, PDA seeds, getUserSigner)
@app/trade/[token]/actions.ts (pattern: server actions with auth, SQL aggregation, BigInt handling)
@lib/db/schema.ts (trade, contentUnlock tables for aggregation)
@app/(dashboard)/dashboard/creator/page.tsx (existing creator dashboard)
@programs/baremint/src/state/vesting.rs (VestingAccount struct layout)
@programs/baremint/src/state/global_config.rs (vesting config fields)
</context>

<tasks>

<task type="auto">
  <name>Task 1: VestingAccount reader and claimable calculation</name>
  <files>lib/solana/vesting-read.ts</files>
  <action>
Create `lib/solana/vesting-read.ts` following the exact pattern from `bonding-curve-read.ts`:

1. **VestingAccountData interface:**
   - `creator: Address` (32 bytes after 8-byte discriminator)
   - `tokenMint: Address` (32 bytes)
   - `totalAllocation: bigint` (u64, 8 bytes)
   - `claimedAmount: bigint` (u64, 8 bytes)
   - `startTimestamp: bigint` (i64, 8 bytes) -- use BigInt for signed 64-bit
   - `isRevoked: boolean` (1 byte)
   - `bump: number` (1 byte)

2. **readVestingAccount(mintAddress: string):**
   - Derive PDA: seeds = `["vesting", mintAddressBytes]` with PROGRAM_ID
   - Fetch via `rpc.getAccountInfo(vestingAddress, { encoding: "base64" }).send()`
   - Deserialize from base64 buffer (skip 8-byte Anchor discriminator)
   - Use `getAddressDecoder().decode()` for Pubkey fields (same as bonding-curve-read.ts)
   - Use DataView for u64/i64 fields (little-endian)
   - Return `VestingAccountData | null` (null if account doesn't exist)

3. **calculateClaimable(vesting, config):**
   - Takes `VestingAccountData` and `GlobalConfigAccount` (from bonding-curve-read.ts)
   - If `isRevoked`, return `BigInt(0)`
   - Calculate `cliffEnd = startTimestamp + config.vestingCliffSeconds`
   - If `now < cliffEnd`, return `BigInt(0)`
   - Calculate elapsed since cliff, cap at `vestingDurationSeconds`
   - Apply weekly snapping: `weeksElapsed = elapsed / config.vestingClaimIntervalSeconds`, `snappedElapsed = weeksElapsed * config.vestingClaimIntervalSeconds` (BigInt floor division)
   - Linear vesting: `totalVested = (totalAllocation * snappedElapsed) / vestingDurationSeconds`
   - Claimable = `totalVested - claimedAmount` (min 0)
   - Return claimable amount as BigInt

Import PROGRAM_ID and getRpcUrl from existing modules (or duplicate the constants to avoid circular deps -- follow how bonding-curve-read.ts handles it).
  </action>
  <verify>
Run `npx tsc --noEmit lib/solana/vesting-read.ts` -- no type errors. Verify the file exports `readVestingAccount`, `VestingAccountData`, and `calculateClaimable`.
  </verify>
  <done>VestingAccount can be read from chain and claimable amount calculated using the same weekly-snapping logic as the on-chain program.</done>
</task>

<task type="auto">
  <name>Task 2: Earnings aggregation server action and dashboard page</name>
  <files>app/trade/[token]/earnings-actions.ts, app/(dashboard)/dashboard/creator/earnings/page.tsx</files>
  <action>
**earnings-actions.ts** -- Create server action file following the exact pattern from `app/trade/[token]/actions.ts`:

1. **getCreatorEarnings(mintAddress: string):**
   - `"use server"` at top of file
   - Authenticate via `auth.api.getSession()` (same pattern as trade actions)
   - Look up the creator's `creatorProfile` to verify ownership of this mint
   - Run three queries in parallel with `Promise.all`:
     a. **Trade fee revenue** (SQL): `SUM(CAST(feeAmount AS NUMERIC) / 2)` from `trade` table where `mintAddress` matches and `status = 'confirmed'`. Creator gets 50% of total fee.
     b. **Burn fee revenue** (SQL): Count of `contentUnlock` records joined with `post` where `post.creatorProfileId` matches. Note: burn fees are included in on-chain `creatorFeesAccrued`, so this is for display count only.
     c. **On-chain reads**: Call `readBondingCurveAccount(mintAddress)` for `creatorFeesAccrued` (current unwithdrawn fees), and `readVestingAccount(mintAddress)` + `readGlobalConfig()` for vesting data.
   - Calculate `calculateClaimable(vesting, globalConfig)` for claimable token amount
   - Return a typed object: `{ tradeFeeRevenue: string, burnCount: number, currentAccruedFees: string, vesting: { total: string, claimed: string, claimable: string, isRevoked: boolean, startTimestamp: string, nextClaimDate: string | null } }`
   - All BigInt values returned as string (JSON-safe)
   - For `nextClaimDate`: calculate the next weekly window boundary after current time, or null if fully claimed/revoked

**earnings/page.tsx** -- Server component for the earnings dashboard:

1. Look up the authenticated user's creatorProfile to get their mintAddress
2. If no token launched, show a message directing to token launch
3. Call `getCreatorEarnings(mintAddress)`
4. Render a dashboard with:
   - **Total Revenue card**: Sum of historical trade fees (from SQL)
   - **Current Accrued card**: SOL amount available to withdraw (from on-chain), with a "Withdraw" button (disabled for now, enabled in 08-02)
   - **Vesting Status card**: Total allocation, claimed, claimable, next claim date, progress bar. "Claim" button (disabled for now, enabled in 08-02)
   - **Revenue Breakdown section**: Trade fee count, burn count, tip count (placeholder 0 until 08-04)
5. Use existing shadcn Card components. Format SOL amounts with `(Number(lamports) / 1e9).toFixed(4)` pattern from existing code.
6. Add a link to this page from the creator dashboard (`app/(dashboard)/dashboard/creator/page.tsx`) -- add an "Earnings" link/button in the creator own profile view when a token exists.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors across the project. Navigate to `/dashboard/creator/earnings` while logged in as a creator with a token -- the page renders with cards showing revenue data (values may be 0 for a fresh token).
  </verify>
  <done>Earnings dashboard page displays trade fee revenue, on-chain accrued fees, and vesting status. Creator can navigate to it from their dashboard.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero type errors
2. `lib/solana/vesting-read.ts` exports `readVestingAccount`, `VestingAccountData`, `calculateClaimable`
3. `app/trade/[token]/earnings-actions.ts` exports `getCreatorEarnings`
4. `/dashboard/creator/earnings` route exists and renders for authenticated creators
5. Earnings page shows: total revenue card, accrued fees card, vesting status card
</verification>

<success_criteria>
- Creator with a launched token sees an earnings dashboard at /dashboard/creator/earnings
- Dashboard shows trade fee revenue (SQL), current accrued fees (on-chain), and vesting status (on-chain)
- VestingAccount reader correctly deserializes the PDA and calculates claimable amounts with weekly snapping
- All BigInt math preserved through the stack (no floating-point until display layer)
</success_criteria>

<output>
After completion, create `.planning/phases/08-creator-monetization-donations/08-01-SUMMARY.md`
</output>
