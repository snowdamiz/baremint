---
phase: 03-creator-onboarding-token-launch
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/schema.ts
  - lib/db/migrate.ts
  - lib/storage/upload.ts
  - app/api/upload/presign/route.ts
  - app/api/creator/profile/route.ts
  - components/creator/onboarding-wizard.tsx
  - components/creator/steps/profile-step.tsx
  - components/creator/image-cropper.tsx
  - app/(dashboard)/dashboard/creator/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to creator onboarding wizard from dashboard"
    - "User can fill in display name, bio, and social links"
    - "User can upload and crop an avatar image (circle crop)"
    - "User can upload and crop a banner image (wide rectangle crop)"
    - "Profile data persists to database after submission"
  artifacts:
    - path: "lib/db/schema.ts"
      provides: "creatorProfile and creatorToken tables"
      contains: "creatorProfile"
    - path: "lib/storage/upload.ts"
      provides: "S3 presigned URL generation"
      exports: ["generatePresignedUploadUrl"]
    - path: "app/api/upload/presign/route.ts"
      provides: "Presigned URL API endpoint"
      exports: ["POST"]
    - path: "app/api/creator/profile/route.ts"
      provides: "Creator profile CRUD"
      exports: ["GET", "POST"]
    - path: "components/creator/onboarding-wizard.tsx"
      provides: "Multi-step wizard container"
      min_lines: 50
    - path: "components/creator/steps/profile-step.tsx"
      provides: "Profile form step"
      min_lines: 40
    - path: "components/creator/image-cropper.tsx"
      provides: "Reusable image crop dialog"
      min_lines: 40
  key_links:
    - from: "components/creator/steps/profile-step.tsx"
      to: "/api/upload/presign"
      via: "fetch for presigned URL before upload"
      pattern: "fetch.*api/upload/presign"
    - from: "components/creator/onboarding-wizard.tsx"
      to: "/api/creator/profile"
      via: "POST to save profile"
      pattern: "fetch.*api/creator/profile"
    - from: "app/api/creator/profile/route.ts"
      to: "db.insert(creatorProfile)"
      via: "Drizzle insert"
      pattern: "creatorProfile"
---

<objective>
Create the creator profile foundation: database schema for creator profiles and tokens, S3-compatible image upload with presigned URLs, and the first steps of the onboarding wizard (profile info + avatar/banner upload with cropping).

Purpose: This is the data layer and profile setup UI that all other Phase 3 plans build on. Without the creatorProfile table and image upload pipeline, KYC and token launch have nowhere to store data.
Output: creatorProfile + creatorToken DB tables, presigned upload API, profile API, wizard shell with profile step and image cropping.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-creator-onboarding-token-launch/03-CONTEXT.md
@.planning/phases/03-creator-onboarding-token-launch/03-RESEARCH.md
@lib/db/schema.ts
@lib/auth.ts
@lib/solana/transfer.ts
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database schema + image upload infrastructure</name>
  <files>
    lib/db/schema.ts
    lib/storage/upload.ts
    app/api/upload/presign/route.ts
    app/api/creator/profile/route.ts
    .env.example
  </files>
  <action>
1. Add creatorProfile and creatorToken tables to lib/db/schema.ts (append after existing tables):

```
creatorProfile: pgTable("creator_profile", {
  id: text("id").primaryKey(),
  userId: text("user_id").notNull().references(() => user.id).unique(),
  displayName: text("display_name").notNull(),
  bio: text("bio"),
  avatarUrl: text("avatar_url"),
  bannerUrl: text("banner_url"),
  socialTwitter: text("social_twitter"),
  socialInstagram: text("social_instagram"),
  socialYoutube: text("social_youtube"),
  socialWebsite: text("social_website"),
  kycStatus: text("kyc_status").notNull().default("none"), // none | pending | approved | rejected
  kycApplicantId: text("kyc_applicant_id"),
  kycRejectionReason: text("kyc_rejection_reason"),
  lastTokenLaunchAt: timestamp("last_token_launch_at"),
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
})

creatorToken: pgTable("creator_token", {
  id: text("id").primaryKey(),
  creatorProfileId: text("creator_profile_id").notNull().references(() => creatorProfile.id),
  tokenName: text("token_name").notNull(),
  tickerSymbol: text("ticker_symbol").notNull(),
  description: text("description"),
  imageUrl: text("image_url"),
  mintAddress: text("mint_address").notNull().unique(),
  bondingCurveAddress: text("bonding_curve_address").notNull(),
  vestingAddress: text("vesting_address").notNull(),
  txSignature: text("tx_signature").notNull(),
  launchedAt: timestamp("launched_at").notNull().defaultNow(),
})
```

2. Create lib/storage/upload.ts with S3 presigned URL generation using @aws-sdk/client-s3 and @aws-sdk/s3-request-presigner. Export `generatePresignedUploadUrl(key: string, contentType: string): Promise<string>`. Read S3_BUCKET, S3_REGION, S3_ENDPOINT, S3_ACCESS_KEY_ID, S3_SECRET_ACCESS_KEY from env. Use PutObjectCommand with 5MB max content length, 15-minute expiry. Key format: `creators/{userId}/{uuid}.{ext}`.

3. Create app/api/upload/presign/route.ts: POST endpoint accepting `{ fileName: string, contentType: string }`. Validate contentType is image/jpeg, image/png, or image/webp. Require authenticated session (use auth from @/lib/auth). Generate a unique key and return `{ uploadUrl, publicUrl }`.

4. Create app/api/creator/profile/route.ts with GET and POST handlers:
   - GET: Return current user's creator profile (or null if not exists)
   - POST: Accept `{ displayName, bio, avatarUrl, bannerUrl, socialTwitter, socialInstagram, socialYoutube, socialWebsite }`. Validate displayName length 2-50 chars. If profile exists, update all fields EXCEPT displayName (prevent impersonation per CONTEXT.md). If no profile, create new with crypto.randomUUID() as id.
   - Both require authenticated session.

5. Add S3 env vars to .env.example:
```
# S3-compatible storage (for image uploads)
S3_BUCKET=
S3_REGION=
S3_ENDPOINT=
S3_ACCESS_KEY_ID=
S3_SECRET_ACCESS_KEY=
```

6. Run `npx drizzle-kit push` to apply schema changes (or `npx drizzle-kit generate` + `npx drizzle-kit migrate` depending on existing pattern -- check package.json scripts).
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no errors
    - `npm run build` succeeds
    - Schema tables visible: check with `npx drizzle-kit studio` or direct DB query
  </verify>
  <done>
    creatorProfile and creatorToken tables exist in schema.ts, presigned upload API returns valid URL structure, profile API can create and retrieve profiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Onboarding wizard shell with profile step and image cropping</name>
  <files>
    components/creator/onboarding-wizard.tsx
    components/creator/steps/profile-step.tsx
    components/creator/image-cropper.tsx
    app/(dashboard)/dashboard/creator/page.tsx
  </files>
  <action>
1. Install dependencies: `npm install react-image-crop` (already identified in RESEARCH.md).

2. Create components/creator/image-cropper.tsx:
   - A dialog/modal component that accepts an image file, displays it with ReactCrop from react-image-crop
   - Props: `{ open, onClose, onCropComplete: (blob: Blob) => void, aspect: number, circularCrop?: boolean }`
   - For avatar: circularCrop=true, aspect=1
   - For banner: circularCrop=false, aspect=3 (or 16/5 wide)
   - On confirm: use canvas to extract cropped region at output resolution (avatar: 400x400, banner: 1200x400), convert to blob, call onCropComplete
   - Import CSS: `import 'react-image-crop/dist/ReactCrop.css'`

3. Create components/creator/steps/profile-step.tsx:
   - Form with fields: displayName (required, 2-50 chars), bio (textarea, optional, max 500 chars), socialTwitter, socialInstagram, socialYoutube, socialWebsite (all optional URL inputs)
   - Avatar upload button: opens file picker, then image-cropper dialog with circularCrop. On crop complete: upload to S3 via presigned URL (fetch POST /api/upload/presign, then PUT to returned uploadUrl), store publicUrl in state
   - Banner upload same pattern but aspect=3, no circularCrop
   - Show preview of avatar (circle) and banner (wide rectangle) after upload
   - Props: `{ data, onChange: (data) => void, onNext: () => void }` where data contains all profile fields + avatarUrl + bannerUrl
   - Use shadcn/ui components (Input, Textarea, Button, Label) consistent with existing codebase

4. Create components/creator/onboarding-wizard.tsx:
   - useState for currentStep (0-based index), wizard data object
   - Steps array: ['profile', 'kyc', 'token-config', 'launch-review', 'launch-success']
   - Step indicator at top showing progress (numbered dots or progress bar)
   - Only render ProfileStep for now (other steps will be stubs showing "Coming soon" or just the step name)
   - On profile step completion: POST to /api/creator/profile with form data
   - Handle errors with toast (sonner)

5. Create app/(dashboard)/dashboard/creator/page.tsx:
   - Server component that checks if user has existing creator profile (fetch from API or direct DB query via server component)
   - If no profile: render OnboardingWizard
   - If profile exists and KYC not approved: render wizard starting at KYC step
   - If profile exists and KYC approved: render wizard at token config step (or redirect to creator dashboard -- for now just show wizard)
   - Add "use client" only on the wizard component, keep page as server component
   - Add a link/button to this page from the main dashboard page.tsx
  </action>
  <verify>
    - `npm run build` succeeds
    - Navigate to /dashboard/creator -- wizard renders with profile step
    - Can fill in display name, bio, social links
    - Avatar upload opens cropper dialog, cropping produces a blob (S3 upload will fail without real S3 creds, but the flow should work up to the upload call)
    - Profile form validates displayName length
  </verify>
  <done>
    Creator onboarding wizard at /dashboard/creator with functional profile step. Avatar and banner image cropping works in-browser. Profile data saves to database via API. Wizard shows step indicator and navigates forward on completion.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` -- no TypeScript errors
- `npm run build` -- production build succeeds
- Database has creator_profile and creator_token tables
- /dashboard/creator page loads the wizard
- Profile step form validates and submits
- Image cropper opens and produces cropped output
</verification>

<success_criteria>
- creatorProfile and creatorToken tables in schema with all fields from RESEARCH.md
- Presigned upload API generates valid S3 URLs
- Profile API creates and updates creator profiles
- Onboarding wizard renders at /dashboard/creator with step indicator
- Profile step collects displayName, bio, social links, avatar, banner
- Image cropper handles circle (avatar) and rectangle (banner) crops
- Display name is immutable after initial profile creation
</success_criteria>

<output>
After completion, create `.planning/phases/03-creator-onboarding-token-launch/03-01-SUMMARY.md`
</output>
