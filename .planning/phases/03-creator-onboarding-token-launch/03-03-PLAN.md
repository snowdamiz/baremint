---
phase: 03-creator-onboarding-token-launch
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - lib/solana/create-token.ts
  - app/api/creator/launch/route.ts
  - components/creator/steps/token-config-step.tsx
  - components/creator/steps/launch-review-step.tsx
  - components/creator/steps/launch-success-step.tsx
  - components/creator/onboarding-wizard.tsx
autonomous: true

must_haves:
  truths:
    - "Creator can configure token name, ticker symbol, image, and description"
    - "Creator sees a review screen with token details, vesting terms, and fee info before launch"
    - "Token launch creates SPL token on-chain via create_token instruction"
    - "Creator sees celebratory success screen with confetti after launch"
    - "Creator with a token launched in the last 90 days cannot launch another"
    - "Creator receives 10% allocation with vesting visible after launch"
  artifacts:
    - path: "lib/solana/create-token.ts"
      provides: "Build and send create_token transaction"
      exports: ["buildAndSendCreateToken"]
    - path: "app/api/creator/launch/route.ts"
      provides: "Token launch API with cooldown enforcement"
      exports: ["POST"]
    - path: "components/creator/steps/token-config-step.tsx"
      provides: "Token configuration form"
      min_lines: 40
    - path: "components/creator/steps/launch-review-step.tsx"
      provides: "Pre-launch review summary"
      min_lines: 30
    - path: "components/creator/steps/launch-success-step.tsx"
      provides: "Post-launch celebration with confetti"
      min_lines: 30
  key_links:
    - from: "app/api/creator/launch/route.ts"
      to: "lib/solana/create-token.ts"
      via: "Calls buildAndSendCreateToken"
      pattern: "buildAndSendCreateToken"
    - from: "lib/solana/create-token.ts"
      to: "create_token instruction"
      via: "@solana/kit pipe pattern with Anchor IDL"
      pattern: "pipe.*createTransactionMessage"
    - from: "app/api/creator/launch/route.ts"
      to: "db.insert(creatorToken)"
      via: "Records token in database after successful tx"
      pattern: "creatorToken"
    - from: "components/creator/steps/launch-review-step.tsx"
      to: "/api/creator/launch"
      via: "POST to trigger on-chain transaction"
      pattern: "fetch.*api/creator/launch"
---

<objective>
Implement the token launch flow: token configuration step, pre-launch review screen, on-chain create_token transaction via the existing Anchor program, and post-launch celebration. Enforces 90-day cooldown server-side.

Purpose: This is the core action of Phase 3 -- a verified creator actually launches their SPL token on the bonding curve. The on-chain transaction initializes the mint, bonding curve PDA, and vesting account.
Output: create-token transaction builder, launch API, token config/review/success wizard steps.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-creator-onboarding-token-launch/03-CONTEXT.md
@.planning/phases/03-creator-onboarding-token-launch/03-RESEARCH.md
@.planning/phases/03-creator-onboarding-token-launch/03-01-SUMMARY.md
@.planning/phases/03-creator-onboarding-token-launch/03-02-SUMMARY.md
@lib/solana/transfer.ts
@lib/db/schema.ts
@programs/baremint/src/instructions/create_token.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: On-chain create_token transaction builder and launch API</name>
  <files>
    lib/solana/create-token.ts
    app/api/creator/launch/route.ts
  </files>
  <action>
1. Create lib/solana/create-token.ts following the EXACT same pattern as lib/solana/transfer.ts (pipe, createTransactionMessage, setTransactionMessageFeePayer, etc.):

   Export `buildAndSendCreateToken(userId: string, burnSolPrice: number): Promise<{ signature: string, mintAddress: string, bondingCurveAddress: string, vestingAddress: string }>`

   Steps:
   a. Get user wallet from DB, decrypt private key (same as transfer.ts pattern)
   b. Generate a NEW Keypair for the token mint using `generateKeyPair()` from @solana/kit
   c. Derive PDAs:
      - bonding_curve: seeds [b"bonding_curve", mintPubkey]
      - curve_token_account: seeds [b"curve_tokens", mintPubkey]
      - vesting_account: seeds [b"vesting", mintPubkey]
      - vesting_token_account: seeds [b"vesting_tokens", mintPubkey]
      - creator_profile: seeds [b"creator_profile", creatorPubkey]
      - global_config: seeds [b"global_config"]
   d. Build the create_token instruction using the Anchor IDL. The instruction takes `burn_sol_price: u64` as argument. Accounts match CreateToken struct from the Rust program:
      - creator (signer, mut)
      - global_config
      - creator_profile (mut)
      - token_mint (signer, mut) -- the new keypair
      - bonding_curve (mut)
      - curve_token_account (mut)
      - vesting_account (mut)
      - vesting_token_account (mut)
      - token_program
      - system_program
      - rent
   e. Use pipe() pattern to build transaction message
   f. Sign with BOTH the creator wallet signer AND the mint keypair signer (token_mint must co-sign)
   g. Send transaction via RPC
   h. Return signature + all derived addresses

   IMPORTANT: The program ID is FTAssMPiQ8EQUeJA4Rnu6c71maCrUCdnvGetWnVdTXTG (from 02-01 decisions).
   IMPORTANT: Check the Anchor IDL JSON file in target/idl/ or target/types/ for exact instruction discriminator and account ordering. If no IDL JSON exists, manually compute the instruction discriminator as the first 8 bytes of SHA256("global:create_token").
   IMPORTANT: The creator wallet needs sufficient SOL for rent (~0.02-0.03 SOL for 7 accounts). Check balance before attempting.

2. Create app/api/creator/launch/route.ts:
   - POST handler, requires authenticated session
   - Accept `{ tokenName, tickerSymbol, description, imageUrl, burnSolPrice }`
   - Validate:
     - tokenName: 2-32 chars
     - tickerSymbol: 2-10 chars, uppercase letters only
     - burnSolPrice: positive number
   - Server-side checks:
     - creatorProfile must exist with kycStatus === 'approved'
     - 90-day cooldown: if lastTokenLaunchAt exists, check `Date.now() - lastTokenLaunchAt > 90 * 24 * 60 * 60 * 1000`. Return 403 with "You must wait {days} more days" if violated.
     - Check user wallet SOL balance >= 0.05 SOL (buffer for rent + fees)
   - Call buildAndSendCreateToken(userId, burnSolPrice)
   - On success:
     - Insert into creatorToken table with all addresses and txSignature
     - Update creatorProfile.lastTokenLaunchAt to now
     - Return `{ success: true, mintAddress, txSignature, bondingCurveAddress, vestingAddress }`
   - On failure: return 500 with error message
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - PDA derivation logic matches seed patterns in create_token.rs
    - 90-day cooldown check uses correct millisecond math
  </verify>
  <done>
    create-token transaction builder follows established @solana/kit pipe pattern. Launch API enforces KYC approval + 90-day cooldown server-side. On-chain transaction initializes mint, bonding curve, and vesting accounts. Token data recorded in creatorToken table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Token config, review, and success wizard steps</name>
  <files>
    components/creator/steps/token-config-step.tsx
    components/creator/steps/launch-review-step.tsx
    components/creator/steps/launch-success-step.tsx
    components/creator/onboarding-wizard.tsx
  </files>
  <action>
1. Install: `npm install canvas-confetti && npm install -D @types/canvas-confetti`

2. Create components/creator/steps/token-config-step.tsx:
   - Form fields: tokenName (input, 2-32 chars), tickerSymbol (input, 2-10 chars, auto-uppercase), description (textarea, max 200 chars), tokenImage
   - Token image: defaults to creator's avatar URL (passed via props) with "Use custom image" toggle that opens file picker + image-cropper (square aspect=1, 400x400 output)
   - Upload custom image via presigned URL (same pattern as avatar)
   - Show character count for tokenName and tickerSymbol
   - Burn SOL price input: numeric input for how much SOL it costs to burn tokens for content access (default 0.01 SOL). Show explanation tooltip.
   - Props: `{ data, avatarUrl, onChange, onNext, onBack }`
   - Validate all fields on "Next"

3. Create components/creator/steps/launch-review-step.tsx:
   - Summary card showing:
     - Token name + ticker
     - Token image (preview)
     - Description
     - Supply: 1,000,000,000 (formatted)
     - Creator allocation: 10% (100,000,000 tokens)
     - Vesting: 30-day cliff + 60-day linear vest
     - Burn price: {burnSolPrice} SOL
     - Platform fee: shown from GlobalConfig (2.5% buy, 2.5% sell -- hardcode display for now)
   - Warning box: "Launching a token is permanent. You cannot launch another token for 90 days."
   - "Launch Token" button with loading state
   - On click: POST to /api/creator/launch with all token data
   - On success: call onLaunchComplete with response data
   - On error: show toast with error message, stay on review step
   - Props: `{ data, onLaunchComplete: (result) => void, onBack }`

4. Create components/creator/steps/launch-success-step.tsx:
   - Trigger confetti on mount using canvas-confetti: `confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } })`
   - Show celebration message: "Your token is live!"
   - Display: token name, ticker, mint address (truncated with copy button)
   - Show vesting timeline summary: "Your 10% allocation vests over 60 days after a 30-day cliff"
   - Share links: "Share on Twitter" (pre-filled tweet with token name), "Copy link" to token page
   - "Go to Dashboard" button
   - Props: `{ tokenName, tickerSymbol, mintAddress, txSignature }`

5. Update components/creator/onboarding-wizard.tsx:
   - Wire TokenConfigStep, LaunchReviewStep, LaunchSuccessStep into steps array
   - Pass avatarUrl from profile data to TokenConfigStep
   - Handle launch completion: update wizard state with mint data, advance to success step
   - On success step "Go to Dashboard": navigate to /dashboard
   - Disable back navigation on success step (launch is irreversible)
  </action>
  <verify>
    - `npm run build` succeeds
    - Token config step validates inputs and shows character counts
    - Review step shows complete summary with vesting terms
    - Success step fires confetti on mount (visual check in browser)
    - Full wizard flow navigates: Profile -> KYC -> Token Config -> Review -> Success
  </verify>
  <done>
    Complete token launch wizard flow. Token config collects name/ticker/image/description. Review shows full summary with warnings. Launch button triggers on-chain transaction. Success screen shows confetti and share links.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` -- no TypeScript errors
- `npm run build` -- production build succeeds
- Full wizard flow navigable from start to finish
- Launch API returns 403 for unapproved KYC
- Launch API returns 403 for cooldown violation
- On-chain transaction builder derives correct PDAs matching Rust seeds
</verification>

<success_criteria>
- create_token transaction follows lib/solana/transfer.ts pipe pattern
- Launch API enforces KYC approval gate and 90-day cooldown
- Token config step collects all required fields with validation
- Review step displays complete token details + vesting terms + warnings
- Success step shows confetti animation and share links
- Token data persisted to creatorToken table with all on-chain addresses
- Mint keypair co-signs transaction (required by create_token instruction)
</success_criteria>

<output>
After completion, create `.planning/phases/03-creator-onboarding-token-launch/03-03-SUMMARY.md`
</output>
