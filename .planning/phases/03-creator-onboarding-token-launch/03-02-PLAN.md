---
phase: 03-creator-onboarding-token-launch
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - lib/sumsub/token.ts
  - lib/sumsub/webhook.ts
  - app/api/sumsub/token/route.ts
  - app/api/sumsub/webhook/route.ts
  - app/api/creator/kyc-status/route.ts
  - components/creator/steps/kyc-step.tsx
  - components/creator/onboarding-wizard.tsx
  - .env.example
autonomous: true
user_setup:
  - service: sumsub
    why: "KYC identity verification for creators"
    env_vars:
      - name: SUMSUB_APP_TOKEN
        source: "Sumsub Dashboard -> Developers -> App Tokens"
      - name: SUMSUB_SECRET_KEY
        source: "Sumsub Dashboard -> Developers -> App Tokens (secret shown once)"
      - name: SUMSUB_WEBHOOK_SECRET
        source: "Sumsub Dashboard -> Developers -> Webhooks -> Secret key"
    dashboard_config:
      - task: "Create KYC verification level with ID document + liveness check"
        location: "Sumsub Dashboard -> Verification Levels"
      - task: "Add webhook endpoint URL pointing to /api/sumsub/webhook"
        location: "Sumsub Dashboard -> Developers -> Webhooks"

must_haves:
  truths:
    - "Creator can open embedded Sumsub KYC widget inside the app"
    - "Creator can complete ID document upload and liveness check without leaving the app"
    - "KYC status updates from pending to approved/rejected via webhook"
    - "Creator can manually check KYC status if webhook is slow"
    - "Rejected creator sees rejection reason and can retry"
  artifacts:
    - path: "lib/sumsub/token.ts"
      provides: "HMAC-signed Sumsub access token generation"
      exports: ["generateSumsubAccessToken"]
    - path: "lib/sumsub/webhook.ts"
      provides: "Webhook signature verification and status processing"
      exports: ["verifySumsubWebhook", "processSumsubEvent"]
    - path: "app/api/sumsub/token/route.ts"
      provides: "Access token endpoint for WebSDK"
      exports: ["POST"]
    - path: "app/api/sumsub/webhook/route.ts"
      provides: "Webhook receiver for KYC status updates"
      exports: ["POST"]
    - path: "components/creator/steps/kyc-step.tsx"
      provides: "Embedded Sumsub WebSDK step"
      min_lines: 50
  key_links:
    - from: "components/creator/steps/kyc-step.tsx"
      to: "/api/sumsub/token"
      via: "fetch to get access token for WebSDK initialization"
      pattern: "fetch.*api/sumsub/token"
    - from: "app/api/sumsub/webhook/route.ts"
      to: "db.update(creatorProfile)"
      via: "Update kycStatus on webhook event"
      pattern: "kycStatus.*approved|rejected"
    - from: "lib/sumsub/token.ts"
      to: "Sumsub API"
      via: "HMAC-signed POST to /resources/accessTokens"
      pattern: "createHmac.*sha256"
---

<objective>
Integrate Sumsub KYC verification into the onboarding wizard. Creators complete ID verification through an embedded WebSDK widget. Server handles access token generation (HMAC-signed), webhook processing for status updates, and manual status polling as fallback.

Purpose: KYC verification is a gate before token launch -- creators must be verified to prevent anonymous rug-pulls. This is a locked decision from CONTEXT.md.
Output: Sumsub access token API, webhook handler, KYC step in wizard, status polling endpoint.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-creator-onboarding-token-launch/03-CONTEXT.md
@.planning/phases/03-creator-onboarding-token-launch/03-RESEARCH.md
@.planning/phases/03-creator-onboarding-token-launch/03-01-SUMMARY.md
@lib/db/schema.ts
@lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sumsub server-side integration (token generation + webhook)</name>
  <files>
    lib/sumsub/token.ts
    lib/sumsub/webhook.ts
    app/api/sumsub/token/route.ts
    app/api/sumsub/webhook/route.ts
    app/api/creator/kyc-status/route.ts
    .env.example
  </files>
  <action>
1. Create lib/sumsub/token.ts:
   - Export `generateSumsubAccessToken(userId: string, levelName?: string): Promise<{ token: string, userId: string }>`
   - Makes POST to `https://api.sumsub.com/resources/accessTokens?userId={userId}&levelName={levelName || 'basic-kyc-level'}`
   - HMAC signature: `crypto.createHmac('sha256', SUMSUB_SECRET_KEY).update(ts + 'POST' + path + body).digest('hex')`
   - Headers: `X-App-Token: SUMSUB_APP_TOKEN`, `X-App-Access-Ts: {unix_timestamp}`, `X-App-Access-Sig: {hmac_hex}`
   - IMPORTANT: Sumsub HMAC signature format is: timestamp (as string) + HTTP_METHOD (uppercase) + URL_PATH (with query params) + request_body (if any). The path must include query string.
   - Return the access token from response

2. Create lib/sumsub/webhook.ts:
   - Export `verifySumsubWebhook(rawBody: string, digestHeader: string): boolean`
     - Compute HMAC-SHA256 of rawBody with SUMSUB_WEBHOOK_SECRET, compare to digestHeader
   - Export `processSumsubEvent(payload: any): { applicantId: string, reviewStatus: string, rejectionReason?: string }`
     - Parse Sumsub webhook payload: extract applicantId, reviewStatus from reviewResult
     - Map reviewStatus: 'completed' -> 'approved', 'rejected' -> 'rejected'

3. Create app/api/sumsub/token/route.ts:
   - POST handler, requires authenticated session
   - Look up user's creatorProfile to get/set kycApplicantId
   - Call generateSumsubAccessToken with the user's ID as externalUserId
   - Return `{ token }` for client-side WebSDK initialization

4. Create app/api/sumsub/webhook/route.ts:
   - POST handler (no auth -- Sumsub sends this)
   - Read raw body, verify signature via verifySumsubWebhook using `x-payload-digest` header
   - If invalid signature, return 401
   - Process event: find creatorProfile by kycApplicantId, update kycStatus
   - If rejected: also store kycRejectionReason
   - Return 200

5. Create app/api/creator/kyc-status/route.ts:
   - GET handler, requires authenticated session
   - Return `{ status: creatorProfile.kycStatus, rejectionReason: creatorProfile.kycRejectionReason }`
   - This is the manual polling fallback per CONTEXT.md (in case webhook is slow/missed)

6. Add Sumsub env vars to .env.example:
```
# Sumsub KYC
SUMSUB_APP_TOKEN=
SUMSUB_SECRET_KEY=
SUMSUB_WEBHOOK_SECRET=
```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - Token generation function compiles and exports correctly
    - Webhook handler returns 401 on invalid signature (unit testable)
  </verify>
  <done>
    Sumsub access token generation with correct HMAC signature. Webhook handler verifies signatures and updates KYC status in database. Manual KYC status polling endpoint available.
  </done>
</task>

<task type="auto">
  <name>Task 2: KYC step in onboarding wizard</name>
  <files>
    components/creator/steps/kyc-step.tsx
    components/creator/onboarding-wizard.tsx
  </files>
  <action>
1. Install Sumsub WebSDK: `npm install @sumsub/websdk-react`

2. Create components/creator/steps/kyc-step.tsx:
   - "use client" component
   - On mount: fetch POST /api/sumsub/token to get access token
   - Render SumsubWebSdk from @sumsub/websdk-react with:
     - accessToken from API response
     - onMessage callback: listen for 'idCheck.onApplicantStatusChanged' event
     - onError callback: show toast with error
   - Below the widget, show a "Check Status" button that polls GET /api/creator/kyc-status
   - States:
     - Loading: spinner while fetching token
     - Active: Sumsub widget rendered
     - Pending: "Your verification is being reviewed" message + Check Status button
     - Approved: success message + auto-advance to next step
     - Rejected: show rejection reason from kycRejectionReason + "Try Again" button that re-fetches token and re-mounts widget
   - Props: `{ kycStatus: string, onStatusChange: (status: string) => void, onNext: () => void }`

3. Update components/creator/onboarding-wizard.tsx:
   - Import and wire KycStep as the second step
   - When KYC step reports 'approved', enable advancing to token config step
   - When KYC is 'pending', allow user to continue viewing the wizard but disable the "Next" button for token config
   - Pass current kycStatus from wizard data to KycStep
   - After profile step completes (POST to profile API), also check if kycApplicantId already exists (user returning to wizard) and set initial KYC status accordingly
  </action>
  <verify>
    - `npm run build` succeeds
    - Navigate to /dashboard/creator, complete profile step, advance to KYC step
    - KYC step shows loading spinner then Sumsub widget (will show "config error" without real Sumsub credentials, which is expected)
    - Check Status button makes GET request to /api/creator/kyc-status
    - Rejection state shows reason and retry button
  </verify>
  <done>
    KYC step embedded in wizard with Sumsub WebSDK. Status polling works. Rejection shows reason with retry option. Approved status auto-advances wizard.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` -- no TypeScript errors
- `npm run build` -- production build succeeds
- Sumsub token endpoint generates HMAC-signed tokens
- Webhook endpoint verifies signatures and updates DB
- KYC step renders in wizard at position 2
- Manual status polling returns correct KYC status
</verification>

<success_criteria>
- Sumsub access token generated with correct HMAC-SHA256 signature format
- Webhook handler verifies payload signature and updates creatorProfile.kycStatus
- KYC step embeds Sumsub WebSDK React component
- Rejected creators see reason and can retry
- Manual "Check Status" button polls API as webhook fallback
- KYC approval enables advancing to token configuration step
</success_criteria>

<output>
After completion, create `.planning/phases/03-creator-onboarding-token-launch/03-02-SUMMARY.md`
</output>
