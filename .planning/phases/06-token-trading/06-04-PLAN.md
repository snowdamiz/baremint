---
phase: 06-token-trading
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-03"]
files_modified:
  - app/trade/[token]/price-chart.tsx
  - app/trade/[token]/price-chart-inner.tsx
  - app/trade/[token]/curve-viz.tsx
  - app/trade/[token]/page.tsx
  - app/trade/[token]/actions.ts
autonomous: true

must_haves:
  truths:
    - "Viewer can see a candlestick price chart on the trade page with selectable time intervals"
    - "Viewer can see a bonding curve visualization showing current position on the curve"
    - "Chart falls back to a simple price line when insufficient trade history exists"
    - "Time interval selector supports 5M, 15M, 1H, 4H, 1D, 1W"
  artifacts:
    - path: "app/trade/[token]/price-chart.tsx"
      provides: "Dynamic import wrapper for price chart (SSR-safe)"
      exports: ["PriceChart"]
    - path: "app/trade/[token]/price-chart-inner.tsx"
      provides: "TradingView Lightweight Charts candlestick/line chart implementation"
      exports: ["default"]
    - path: "app/trade/[token]/curve-viz.tsx"
      provides: "Bonding curve visualization (collapsible)"
      exports: ["CurveViz"]
  key_links:
    - from: "app/trade/[token]/price-chart-inner.tsx"
      to: "lightweight-charts"
      via: "createChart, CandlestickSeries, LineSeries"
      pattern: "import.*lightweight-charts"
    - from: "app/trade/[token]/price-chart.tsx"
      to: "app/trade/[token]/price-chart-inner.tsx"
      via: "dynamic import with ssr: false"
      pattern: "dynamic.*import.*price-chart-inner"
    - from: "app/trade/[token]/actions.ts"
      to: "lib/db/schema.ts"
      via: "getOhlcvData query from trade table"
      pattern: "trade.*status.*confirmed"
---

<objective>
Add candlestick price chart and bonding curve visualization to the trade page using TradingView Lightweight Charts.

Purpose: Satisfies TOKN-04 (token price chart and bonding curve visualization). Traders need price history to make informed decisions. The bonding curve viz shows how much SOL is in reserves and where on the curve the current price sits.

Output: Candlestick chart with time interval selector, bonding curve visualization as collapsible widget, OHLCV data query in server actions.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-token-trading/06-RESEARCH.md
@.planning/phases/06-token-trading/06-01-SUMMARY.md
@.planning/phases/06-token-trading/06-03-SUMMARY.md

@app/trade/[token]/page.tsx — Existing trade page to integrate chart components into
@app/trade/[token]/actions.ts — Add getOhlcvData and getChartData server actions
@lib/db/schema.ts — trade table for OHLCV aggregation queries
@lib/solana/bonding-curve-read.ts — readBondingCurveAccount for curve viz data
</context>

<tasks>

<task type="auto">
  <name>Task 1: Price chart with TradingView Lightweight Charts</name>
  <files>
    app/trade/[token]/price-chart.tsx
    app/trade/[token]/price-chart-inner.tsx
    app/trade/[token]/actions.ts
  </files>
  <action>
Install dependency: `npm install lightweight-charts`

**1. Add `getChartData` server action to `app/trade/[token]/actions.ts`:**

Export `getChartData(mintAddress: string, interval: string)`:
- Validate interval is one of: "5M", "15M", "1H", "4H", "1D", "1W"
- Map interval to SQL truncation: 5M -> 5 minutes, 15M -> 15 minutes, etc.
- Query confirmed trades from `trade` table for this mintAddress, grouped by time bucket:
  ```sql
  SELECT
    date_trunc('hour', created_at) as time,  -- adjust truncation per interval
    MIN(price_per_token) as low,
    MAX(price_per_token) as high,
    (array_agg(price_per_token ORDER BY created_at ASC))[1] as open,
    (array_agg(price_per_token ORDER BY created_at DESC))[1] as close,
    SUM(sol_amount) as volume
  FROM trade
  WHERE mint_address = ? AND status = 'confirmed'
  GROUP BY time
  ORDER BY time ASC
  ```
- Use drizzle `sql` template for the raw aggregation query (drizzle ORM doesn't have built-in OHLCV support)
- If fewer than 5 data points, return `{ type: "line", data: [...] }` with simple price points
- If 5+ data points across multiple time buckets, return `{ type: "candlestick", data: [...] }`
- Convert all BigInt/numeric values to number (safe for price display)
- Return data in lightweight-charts format: `{ time: unix_timestamp, open, high, low, close, ?value }`

**2. Create `app/trade/[token]/price-chart.tsx`** — Dynamic import wrapper ("use client"):

```typescript
"use client";
import dynamic from "next/dynamic";

const PriceChartInner = dynamic(() => import("./price-chart-inner"), {
  ssr: false,
  loading: () => <div className="h-[400px] w-full animate-pulse bg-muted rounded-lg" />,
});

export function PriceChart(props: { mintAddress: string; initialData?: any }) {
  return <PriceChartInner {...props} />;
}
```

This prevents SSR crash from lightweight-charts accessing `document`/`window`.

**3. Create `app/trade/[token]/price-chart-inner.tsx`** — Actual chart implementation ("use client"):

- Use `useRef` for chart container div and chart instance
- Use `useEffect` to create chart on mount:
  ```typescript
  import { createChart, CandlestickSeries, LineSeries } from "lightweight-charts";
  ```
  - Create chart with `createChart(containerRef.current, { width, height: 400, layout: { background: { color: 'transparent' }, textColor: theme-based } })`
  - Responsive: Use `ResizeObserver` on container to call `chart.applyOptions({ width: newWidth })`
  - Apply dark theme colors matching the app's dark mode
- Time interval selector: Row of buttons (5M, 15M, 1H, 4H, 1D, 1W) above the chart
  - On interval change, fetch new data via `getChartData` server action
  - Show loading state while fetching
- Data rendering:
  - If data.type === "candlestick": `chart.addSeries(CandlestickSeries, { upColor: '#22c55e', downColor: '#ef4444', ... })`
  - If data.type === "line": `chart.addSeries(LineSeries, { color: '#6366f1', ... })`
  - Call `series.setData(data.data)`
- Crosshair: Enable by default with tooltip showing OHLCV values
- Empty state: If no data at all, show a centered message "No trades yet" over a flat line at current spot price
- Cleanup: Return cleanup function in useEffect to dispose chart on unmount
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` succeeds (no SSR crash from lightweight-charts)
- Price chart renders in the browser without "document is not defined" errors
- Time interval buttons are visible and clickable
  </verify>
  <done>
- Price chart renders candlestick data when sufficient history exists
- Falls back to line chart for sparse data
- Shows "No trades yet" empty state for new tokens
- Time interval selector (5M, 15M, 1H, 4H, 1D, 1W) fetches fresh data
- No SSR crashes (dynamic import with ssr: false)
  </done>
</task>

<task type="auto">
  <name>Task 2: Bonding curve visualization and page integration</name>
  <files>
    app/trade/[token]/curve-viz.tsx
    app/trade/[token]/page.tsx
  </files>
  <action>
**1. Create `app/trade/[token]/curve-viz.tsx`** — Client component ("use client"):

Collapsible bonding curve visualization widget:
- Use shadcn Collapsible or a simple disclosure with chevron icon
- Default collapsed. Header shows "Bonding Curve" with current position indicator.
- When expanded, render an SVG or canvas visualization:
  - X-axis: Token supply (0 to total_supply)
  - Y-axis: Price (SOL per token)
  - Draw the constant-product curve: for a range of supply values, calculate price as `virtualSolReserves / virtualTokenReserves` at each point
  - Mark current position on the curve with a dot and label (current price, current supply)
  - Fill area under the curve up to current position (representing SOL in reserves)
  - Use Tailwind colors: emerald for filled area, muted for unfilled
- Stats below the curve:
  - SOL in reserves: `realSolReserves` formatted
  - Tokens in circulation: `tokenTotalSupply - realTokenReserves` formatted
  - Curve progress: percentage of max supply in circulation

Props: `{ virtualSolReserves: string, virtualTokenReserves: string, realSolReserves: string, realTokenReserves: string, tokenTotalSupply: string }`

Use inline SVG (no external library). Draw ~50 points along the curve and connect with a smooth path.

**2. Update `app/trade/[token]/page.tsx`** — Integrate chart and curve viz:

- Import and render `PriceChart` component in the left column (below TokenStats)
- Import and render `CurveViz` component below the chart
- Pass appropriate props from server-loaded data
- Add Tabs below chart area with two tabs: "Chart" (already showing) and "History" (placeholder for Plan 05)
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Bonding curve SVG renders without errors
- Curve viz is collapsible (click to expand/collapse)
- Trade page shows price chart + curve viz integrated in layout
  </verify>
  <done>
- Bonding curve visualization shows current position, SOL reserves, and supply progress
- Collapsible by default with expand/collapse toggle
- Price chart and curve viz integrated into trade page layout
- Tab structure prepared for history tab (Plan 05)
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes for all modified files
- `npm run build` succeeds (SSR-safe dynamic import)
- Trade page shows price chart with time interval selector
- Bonding curve visualization renders correctly
- OHLCV data query aggregates confirmed trades properly
</verification>

<success_criteria>
- Candlestick chart displays on trade page with selectable time intervals (TOKN-04)
- Bonding curve visualization shows current position and reserves (TOKN-04)
- Chart gracefully handles empty/sparse data with fallback displays
- No SSR errors from client-only chart libraries
</success_criteria>

<output>
After completion, create `.planning/phases/06-token-trading/06-04-SUMMARY.md`
</output>
