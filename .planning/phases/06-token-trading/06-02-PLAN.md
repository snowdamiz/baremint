---
phase: 06-token-trading
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - app/trade/[token]/page.tsx
  - app/trade/[token]/trade-form.tsx
  - app/trade/[token]/token-stats.tsx
autonomous: true

must_haves:
  truths:
    - "Viewer can navigate to /trade/[token] and see token info with buy/sell tabs"
    - "Viewer enters SOL amount (buy) or token amount (sell) and sees real-time fee breakdown"
    - "Quick-amount buttons (25%, 50%, 75%, MAX) populate the input from wallet balance"
    - "Slippage tolerance is adjustable via gear icon popover (default 1%)"
    - "Trade submission shows sonner toast with tx signature and Solana explorer link"
    - "Trades >= 0.1 SOL show a review dialog before final confirmation"
  artifacts:
    - path: "app/trade/[token]/page.tsx"
      provides: "Trade page server component loading token + curve data"
      exports: ["default"]
    - path: "app/trade/[token]/trade-form.tsx"
      provides: "Buy/sell tabs, amount input, fee breakdown, confirmation flow"
      exports: ["TradeForm"]
    - path: "app/trade/[token]/token-stats.tsx"
      provides: "Token stats card (price, market cap, supply, volume, holders, 24h change)"
      exports: ["TokenStats"]
  key_links:
    - from: "app/trade/[token]/trade-form.tsx"
      to: "app/trade/[token]/actions.ts"
      via: "getQuote for live fee preview, executeBuy/executeSell for trade submission"
      pattern: "import.*actions"
    - from: "app/trade/[token]/page.tsx"
      to: "lib/solana/bonding-curve-read.ts"
      via: "readBondingCurveAccount for initial curve data"
      pattern: "import.*bonding-curve-read"
---

<objective>
Build the trading UI: dedicated trade page with buy/sell tabs, real-time fee breakdown, slippage settings, quick-amount buttons, confirmation dialog, and token stats card.

Purpose: This is the primary user-facing interface for buying and selling creator tokens. It connects to the server actions from Plan 06-01 and provides the fee transparency required by TOKN-03.

Output: Trade page at `/trade/[token]` with complete buy/sell form, live quote preview, fee breakdown, slippage popover, and toast-based trade feedback.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-token-trading/06-CONTEXT.md
@.planning/phases/06-token-trading/06-RESEARCH.md
@.planning/phases/06-token-trading/06-01-SUMMARY.md

@app/trade/[token]/actions.ts — Server actions from Plan 01 (executeBuy, executeSell, getQuote)
@lib/solana/bonding-curve-read.ts — readBondingCurveAccount for page data
@lib/solana/bonding-curve-math.ts — estimateBuy, estimateSell for reference
@lib/db/schema.ts — creatorToken table for token info lookup
@components/wallet/wallet-widget.tsx — Existing wallet widget pattern for balance display
</context>

<tasks>

<task type="auto">
  <name>Task 1: Trade page server component and token stats</name>
  <files>
    app/trade/[token]/page.tsx
    app/trade/[token]/token-stats.tsx
  </files>
  <action>
**1. Create `app/trade/[token]/page.tsx`** — Server component:

- Route parameter `[token]` is the mint address
- Load token data: query `creatorToken` by `mintAddress`, join `creatorProfile` for creator display name and avatar
- Load bonding curve data: call `readBondingCurveAccount(mintAddress)` and `readGlobalConfig()`
- Load user session (optional — page works for unauthenticated viewing)
- If token not found, return `notFound()`
- Layout: Two-column on desktop (chart area left, trade form right), stacked on mobile
- Left column: TokenStats component at top, then placeholder divs for chart and history (Plans 04 and 05)
- Right column: TradeForm client component
- Pass serialized data (BigInts as strings) to client components

**2. Create `app/trade/[token]/token-stats.tsx`** — Client component ("use client"):

Display token information card with:
- Token name, ticker symbol, creator avatar + display name (link to creator profile)
- Current price per token (derived from virtual reserves: virtualSolReserves / virtualTokenReserves, formatted as SOL)
- Market cap: current price * circulating supply (token_total_supply - real_token_reserves)
- Circulating supply: token_total_supply - real_token_reserves (formatted with K/M suffixes)
- 24h volume: placeholder "—" for now (populated after Plan 03 webhook adds trade data)
- Holders: placeholder "—" for now
- 24h change: placeholder "—" for now

Use shadcn Card component. Muted text for labels, bold for values. Compact layout.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Navigate to `/trade/[validMintAddress]` shows the trade page with token stats
- Navigate to `/trade/[invalidMint]` shows 404
- Token stats displays price, market cap, circulating supply from on-chain data
  </verify>
  <done>
- Trade page loads token + curve data server-side and passes to client components
- Token stats card shows price, market cap, circulating supply with proper formatting
- Two-column layout on desktop, stacked on mobile
  </done>
</task>

<task type="auto">
  <name>Task 2: Trade form with fee breakdown, slippage, and confirmation</name>
  <files>app/trade/[token]/trade-form.tsx</files>
  <action>
Create `app/trade/[token]/trade-form.tsx` — Client component ("use client"):

**Trade form structure:**
- Buy/sell tab switcher at top (shadcn Tabs or custom toggle buttons with green/red accent)
- Amount input: SOL input for buy, token amount input for sell. Numeric only, decimal allowed.
- Quick-amount buttons below input: 25%, 50%, 75%, MAX — calculate from user's SOL balance (buy) or token balance (sell). Pass balances as props from page.tsx.
- Slippage gear icon in top-right of form — click opens a Popover (use shadcn Popover) with preset buttons (0.5%, 1%, 2%) and custom input. Default 1% (100 bps). Store in local state.

**Live quote preview:**
- Debounce amount input (300ms). On change, call `getQuote` server action.
- Display below input:
  - "You receive: ~X TOKENS" (buy) or "You receive: ~X SOL" (sell)
  - Fee breakdown always visible: Platform fee | Creator fee | Total fee (all in SOL, formatted to 6 decimal places)
  - Price impact: color-coded — green (<1%), yellow (1-5%), red (>5%) with percentage shown
- While loading quote, show skeleton/shimmer on the values

**Confirmation flow:**
- For trades < 0.1 SOL equivalent: Single "Buy" / "Sell" button. On click, call executeBuy/executeSell directly.
- For trades >= 0.1 SOL: Click opens a review Dialog (shadcn Dialog) showing:
  - Trade summary (type, amount in, estimated amount out)
  - Full fee breakdown
  - Slippage tolerance
  - "Confirm Trade" button
- Button states: disabled when input is empty or zero, loading spinner during submission
- On success: sonner toast with "Trade submitted!" message including tx signature (truncated) and a link to `https://explorer.solana.com/tx/{signature}?cluster=devnet`
- On error: sonner toast with error message (e.g., "Insufficient balance", "Slippage exceeded")

**Holdings card** (below form):
- If user holds tokens for this mint, show a small card:
  - Token balance (formatted)
  - Current value in SOL (balance * current price)
  - Average buy price (from trade history — placeholder for now, will be populated after Plan 05)
- If no holdings, show nothing

Props interface: `{ mintAddress: string, tokenName: string, tickerSymbol: string, initialCurveData: { virtualSolReserves: string, virtualTokenReserves: string, ... }, feeBps: number, userSolBalance: string | null, userTokenBalance: string | null }`

Use sonner `toast.success()` and `toast.error()` for feedback. Use `useTransition` for server action pending state.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Trade form renders buy/sell tabs
- Amount input triggers quote preview (may need mock data without running devnet)
- Fee breakdown displays platform fee, creator fee, total fee
- Slippage popover opens and allows adjustment
- Quick-amount buttons populate input based on balance
  </verify>
  <done>
- Buy/sell tabs switch between SOL input and token input
- Live fee breakdown shows platform fee, creator fee, price impact
- Slippage popover with presets and custom input (default 1%)
- Quick-amount buttons (25%, 50%, 75%, MAX) calculate from balance
- Review dialog for trades >= 0.1 SOL
- Sonner toast with explorer link on trade submission
- Holdings card shows token balance and current value
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes for all new files
- Trade page at `/trade/[token]` renders complete trading interface
- Fee breakdown shows clear platform fee, creator fee, and net amount (TOKN-03)
- Trade form calls server actions and shows appropriate feedback
</verification>

<success_criteria>
- Complete trading UI at /trade/[token] with buy/sell tabs
- Real-time fee preview from getQuote server action
- Slippage tolerance adjustable with Uniswap-style popover
- Trade submission with toast feedback and explorer link
- Token stats card with price, market cap, supply from on-chain data
</success_criteria>

<output>
After completion, create `.planning/phases/06-token-trading/06-02-SUMMARY.md`
</output>
