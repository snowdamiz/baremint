---
phase: 06-token-trading
plan: 05
type: execute
wave: 3
depends_on: ["06-01", "06-03"]
files_modified:
  - app/trade/[token]/trade-history.tsx
  - app/trade/[token]/actions.ts
  - app/trade/[token]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Viewer can see their own trade history on the trade page below the chart"
    - "History shows trade type (buy/sell), token amount, SOL amount, and timestamp"
    - "History only shows the current user's trades (not a global feed)"
    - "Pending trades show a spinner or 'pending' badge until confirmed"
  artifacts:
    - path: "app/trade/[token]/trade-history.tsx"
      provides: "User's trade history list component"
      exports: ["TradeHistory"]
  key_links:
    - from: "app/trade/[token]/trade-history.tsx"
      to: "app/trade/[token]/actions.ts"
      via: "getTradeHistory server action for user's trades"
      pattern: "import.*getTradeHistory.*from.*actions"
    - from: "app/trade/[token]/page.tsx"
      to: "app/trade/[token]/trade-history.tsx"
      via: "Rendered in History tab below chart"
      pattern: "TradeHistory"
---

<objective>
Add transaction history tab showing the user's own trades for a specific token, with human-readable descriptions and status indicators.

Purpose: Users need to see their trade history to track positions and verify past transactions. This completes the trading page experience and provides the data needed for P&L tracking in the holdings card.

Output: Trade history component integrated as a tab below the chart on the trade page, with getTradeHistory server action.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-token-trading/06-RESEARCH.md
@.planning/phases/06-token-trading/06-01-SUMMARY.md
@.planning/phases/06-token-trading/06-03-SUMMARY.md

@lib/db/schema.ts — trade table
@app/trade/[token]/page.tsx — Trade page to integrate history tab
@app/trade/[token]/actions.ts — Add getTradeHistory server action
</context>

<tasks>

<task type="auto">
  <name>Task 1: Trade history server action and UI component</name>
  <files>
    app/trade/[token]/actions.ts
    app/trade/[token]/trade-history.tsx
    app/trade/[token]/page.tsx
  </files>
  <action>
**1. Add `getTradeHistory` server action to `app/trade/[token]/actions.ts`:**

Export `getTradeHistory(mintAddress: string, limit?: number, offset?: number)`:
- Validate auth via `getSession()` — return empty array if not authenticated
- Query `trade` table: `WHERE userId = session.user.id AND mintAddress = mintAddress ORDER BY createdAt DESC LIMIT limit OFFSET offset`
- Default limit: 50, default offset: 0
- Return array of trade objects with BigInt values converted to strings:
  ```typescript
  { id, type, solAmount, tokenAmount, feeAmount, pricePerToken, txSignature, status, createdAt, confirmedAt }
  ```
- Return `{ trades: [...], hasMore: boolean }` (hasMore = true if count > offset + limit)

**2. Create `app/trade/[token]/trade-history.tsx`** — Client component ("use client"):

Compact trade history list:
- Fetch trades on mount via `getTradeHistory` server action
- Each row displays:
  - **Type badge:** Green "BUY" or red "SELL" pill/badge
  - **Amount:** Token amount with ticker symbol (e.g., "1,234 $CRTR")
  - **SOL:** SOL amount formatted (e.g., "0.5 SOL")
  - **Price:** Price per token at execution (e.g., "0.000405 SOL")
  - **Time:** Relative time (e.g., "2m ago", "1h ago", "Jan 31") — use simple relative time formatting (no external library, just a utility function)
  - **Status:** If status is "pending", show a small animated spinner or "Pending" badge in yellow. If "confirmed", show nothing (default). If "failed", show red "Failed" badge.
  - **Explorer link:** Small external-link icon that opens `https://explorer.solana.com/tx/{txSignature}?cluster=devnet` in new tab
- Empty state: "No trades yet" centered message with muted text
- Loading state: Skeleton rows while fetching
- "Load more" button at bottom if hasMore is true — calls getTradeHistory with incremented offset and appends to list

Use a simple table layout on desktop, stacked card layout on mobile. Muted text for secondary info (time, price). Use `Intl.NumberFormat` for SOL/token formatting.

**3. Update `app/trade/[token]/page.tsx`:**
- Import `TradeHistory` component
- Place it inside the "History" tab that was set up in Plan 04
- Pass `mintAddress` and `tickerSymbol` as props
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Trade history renders with proper formatting
- Empty state shows "No trades yet" when no trades exist
- Pending trades display spinner/badge
- Explorer links point to correct Solana explorer URL
  </verify>
  <done>
- Trade history tab shows user's own trades with type, amount, price, time, and status
- Pending trades show visual indicator until confirmed
- Load more pagination works for long history
- Explorer links open tx details in new tab
- Integrated into trade page History tab
  </done>
</task>

<task type="auto">
  <name>Task 2: Holdings card P&L from trade history</name>
  <files>
    app/trade/[token]/trade-form.tsx
    app/trade/[token]/actions.ts
  </files>
  <action>
**1. Add `getHoldings` server action to `app/trade/[token]/actions.ts`:**

Export `getHoldings(mintAddress: string)`:
- Validate auth — return null if not authenticated
- Query confirmed buy trades for this user and mint: `SUM(sol_amount)` as totalSolSpent, `SUM(token_amount)` as totalTokensBought
- Query confirmed sell trades: `SUM(sol_amount)` as totalSolReceived, `SUM(token_amount)` as totalTokensSold
- Calculate:
  - Net tokens = totalTokensBought - totalTokensSold
  - Average buy price = totalSolSpent / totalTokensBought (if any buys exist)
  - Current value = net tokens * current spot price (from bonding curve read)
  - Unrealized P&L = current value - (net tokens * average buy price)
  - P&L percentage = (current value / cost basis - 1) * 100
- Return `{ netTokens, currentValueSol, avgBuyPrice, unrealizedPnl, pnlPercent }` (all as strings)
- Return null if no trades exist

**2. Update holdings card in `app/trade/[token]/trade-form.tsx`:**

The holdings card was created as a placeholder in Plan 02. Now wire it up:
- Call `getHoldings` on mount (alongside the initial quote)
- Display:
  - Token balance (from getHoldings.netTokens, or from on-chain token balance cache)
  - Current value: formatted SOL amount
  - Avg buy price: formatted SOL per token
  - P&L: green if positive, red if negative, with percentage. Example: "+0.05 SOL (+12.3%)" in green
- If no holdings data, hide the card entirely
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Holdings card shows P&L when user has trade history
- P&L calculation correctly uses weighted average buy price
- Card hidden when user has no holdings
  </verify>
  <done>
- Holdings card displays token balance, current value, average buy price, and P&L
- P&L is color-coded green (profit) or red (loss)
- Card hidden for users with no holdings
- All values derived from confirmed trade history
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes for all modified files
- Trade history displays correctly with all formatting
- Holdings card shows accurate P&L from trade data
- Empty states handled gracefully
</verification>

<success_criteria>
- User's trade history visible on trade page with type, amount, price, time, status
- Pending trades show visual indicator
- Holdings card shows P&L tracking with color-coded profit/loss
- Load more pagination works for long history
- Explorer links work for every trade
</success_criteria>

<output>
After completion, create `.planning/phases/06-token-trading/06-05-SUMMARY.md`
</output>
