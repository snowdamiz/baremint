---
phase: 05-token-gated-content
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - app/api/content/[postId]/media/route.ts
  - app/api/token-balance/route.ts
  - components/content/post-card.tsx
  - components/content/unlock-dialog.tsx
  - components/content/post-feed.tsx
autonomous: true

must_haves:
  truths:
    - "Viewer holding enough tokens sees gated media with presigned URLs (images) or signed playback (video)"
    - "Viewer without enough tokens sees blurred placeholder images and a lock overlay"
    - "Post text (caption) is always visible regardless of gating status"
    - "Locked post shows an Unlock button that opens a dialog with balance info and placeholder buy/burn buttons"
    - "Unlock dialog shows viewer's token balance vs required amount"
    - "Original media URLs are never exposed to unauthorized viewers"
  artifacts:
    - path: "app/api/content/[postId]/media/route.ts"
      provides: "Gated content API: returns presigned URLs for authorized, blur URLs for unauthorized"
      exports: ["GET"]
    - path: "components/content/unlock-dialog.tsx"
      provides: "Unlock dialog with balance info and placeholder buy/burn buttons"
      contains: "UnlockDialog"
    - path: "components/content/post-card.tsx"
      provides: "Post card with locked/unlocked media states and lock overlay"
      contains: "isLocked"
  key_links:
    - from: "components/content/post-card.tsx"
      to: "app/api/content/[postId]/media/route.ts"
      via: "fetch for media URLs when post is gated"
      pattern: "api/content.*media"
    - from: "app/api/content/[postId]/media/route.ts"
      to: "lib/content/access-control.ts"
      via: "checkContentAccess for authorization"
      pattern: "checkContentAccess"
    - from: "app/api/content/[postId]/media/route.ts"
      to: "lib/media/signed-urls.ts"
      via: "generateSignedImageUrl and generateSignedPlaybackToken for authorized media"
      pattern: "generateSigned"
    - from: "components/content/post-card.tsx"
      to: "components/content/unlock-dialog.tsx"
      via: "Opens dialog on Unlock button click"
      pattern: "UnlockDialog"
---

<objective>
Wire the gated content rendering end-to-end: a new API endpoint serves authorized or locked media, and the post card renders locked states with blur overlays and an unlock dialog.

Purpose: This is the user-facing layer of content gating. Authorized viewers see content normally (via time-limited signed URLs), while unauthorized viewers see blurred placeholders with a clear path to unlock (hold or burn tokens). The unlock dialog shows balance info and placeholder buy/burn actions that will be wired in Phases 6 and 7.

Output: New gated media API endpoint, updated post card with locked/unlocked states, unlock dialog component, and token balance API endpoint.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-token-gated-content/05-CONTEXT.md
@.planning/phases/05-token-gated-content/05-RESEARCH.md
@.planning/phases/05-token-gated-content/05-01-SUMMARY.md
@.planning/phases/05-token-gated-content/05-02-SUMMARY.md
@lib/content/access-control.ts
@lib/media/signed-urls.ts
@components/content/post-card.tsx
@components/content/post-feed.tsx
@lib/content/post-queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gated content media API and token balance API</name>
  <files>app/api/content/[postId]/media/route.ts, app/api/token-balance/route.ts</files>
  <action>
**Create `app/api/content/[postId]/media/route.ts`:**
This is the core content gating endpoint. It returns media data for a post — either presigned URLs (authorized) or blur placeholders (unauthorized).

- GET handler with `params: Promise<{ postId: string }>`
- Get session via `auth.api.getSession({ headers: await headers() })`
- Fetch the post with media using `getPostById(postId)` from post-queries
- Return 404 if post not found or not published
- If post.accessLevel is "public":
  - Return all media as-is with their public variant URLs and mux playback IDs (same as current behavior)
- If post is gated (hold_gated or burn_gated):
  - If no session: return locked media (blur URLs only, no original URLs, no playback IDs)
  - If session exists:
    - Look up viewer's wallet from `wallet` table by userId
    - Call `checkContentAccess({ accessLevel, tokenThreshold, creatorTokenId }, viewerWallet?.publicKey ?? null)`
    - If hasAccess:
      - For image media: use `getR2KeyFromPublicUrl` to extract R2 key from each variant URL (sm, md, lg — NOT blur), then generate presigned GET URLs via `generateSignedImageUrl(key)`. Return signed variant URLs.
      - For video media: use `generateSignedPlaybackToken(muxPlaybackId)` to get signed playback and thumbnail tokens. Return the playbackId + tokens.
    - If NOT hasAccess:
      - Return locked response: only blur variant URL from media.variants.blur, post's accessLevel, tokenThreshold, viewer's balance, and the creator token's ticker symbol (for display in unlock dialog)
- Response format for authorized: `{ media: [...], isLocked: false }`
- Response format for unauthorized: `{ media: [{ id, type, blurUrl, width, height }], isLocked: true, accessLevel, requiredBalance, viewerBalance, tokenTicker }`
- CRITICAL: Never include original variant URLs or mux playback IDs in the unauthorized response

**Create `app/api/token-balance/route.ts`:**
A simple endpoint for the unlock dialog to fetch the viewer's current token balance for a specific creator token.

- GET handler with query params: `creatorTokenId` (required)
- Get session (require auth, return 401 if not logged in)
- Look up viewer's wallet
- Look up creatorToken to get mintAddress
- Call getCachedTokenBalance(walletPublicKey, mintAddress)
- Return `{ balance: balance.toString(), mintAddress }`
  </action>
  <verify>
Run `npx tsc --noEmit` to verify compilation. Check that the media route handles public/gated paths separately and never leaks original URLs in the gated unauthorized path.
  </verify>
  <done>
Gated content API returns presigned URLs for authorized viewers and blur placeholders for unauthorized viewers. Token balance API returns cached balance. Original media URLs never exposed to unauthorized viewers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update post card with locked/unlocked states and create unlock dialog</name>
  <files>components/content/post-card.tsx, components/content/unlock-dialog.tsx, components/content/post-feed.tsx</files>
  <action>
**Create `components/content/unlock-dialog.tsx`:**
A dialog that shows when a viewer clicks "Unlock" on a locked post.

- Props: `isOpen`, `onClose`, `accessLevel` ("hold_gated" | "burn_gated"), `requiredBalance` (string), `viewerBalance` (string), `tokenTicker` (string), `creatorTokenId` (string)
- Use Dialog from shadcn/ui
- Show title: "Unlock This Content"
- Show gating type explanation:
  - hold_gated: "Hold {requiredBalance} ${tokenTicker} tokens to access this creator's gated content"
  - burn_gated: "Burn {requiredBalance} ${tokenTicker} tokens for permanent access to this post"
- Show balance comparison: "Your balance: {viewerBalance} / {requiredBalance} ${tokenTicker}"
- Show a progress-bar style indicator of viewerBalance / requiredBalance (visual fraction)
- If viewer has enough (viewerBalance >= requiredBalance), show a green success message "You have enough tokens! Access will be granted automatically."
- Show two action buttons (placeholder, non-functional in Phase 5):
  - "Buy ${tokenTicker} Tokens" — styled as primary button, onClick shows a toast "Trading coming soon" (use sonner)
  - For burn_gated only: "Burn to Unlock" — styled as secondary button, onClick shows toast "Burn-to-unlock coming soon"
- The buttons should look functional/real but just show the coming-soon toast — per user decision, viewers shouldn't feel like the feature is broken

**Update `components/content/post-card.tsx`:**
- Extend the `PostData` interface with: `accessLevel?: string`, `isLocked?: boolean`
- Extend the `MediaRecord` interface with: `blurUrl?: string | null`
- Add new props to PostCardProps: `tokenTicker?: string`, `requiredBalance?: string`, `viewerBalance?: string`, `creatorTokenId?: string`
- When `post.isLocked` is true:
  - Show images as blurred: use `media.blurUrl` as the image src with a lock overlay (a semi-transparent dark overlay with a lock icon from lucide-react and text "Hold {threshold} ${ticker} to unlock")
  - Show videos as blurred: use `media.blurUrl` as a static image (not a video player) with the same lock overlay
  - Add an "Unlock" button below the media area (styled prominently)
  - Clicking "Unlock" opens the UnlockDialog
- When `post.isLocked` is false (or accessLevel is "public"):
  - For gated posts with authorized access: render images using presigned variant URLs (they'll be in media.variants as before), render videos using MuxPlayer with `tokens={{ playback: media.playbackToken, thumbnail: media.thumbnailToken }}` prop
  - For public posts: render as before (no changes to current behavior)
- Post text/caption is ALWAYS shown regardless of lock status (per user decision)
- Do NOT show engagement metadata (unlock counts, social proof) on locked posts (per user decision)
- Add a small badge/indicator on gated posts to show they're gated (e.g., a small lock icon next to the timestamp for hold_gated, a fire icon for burn_gated) — visible to both the creator and viewers

**Update `components/content/post-feed.tsx`:**
- When fetching posts for the feed, also fetch gated media data via the new `/api/content/{postId}/media` endpoint for posts with accessLevel !== "public"
- Pass the gated media data (isLocked, viewerBalance, requiredBalance, tokenTicker) to PostCard
- For public posts, continue using the existing media data directly (no additional API call needed)
- Consider fetching gated media data lazily (on component mount or when scrolled into view) to avoid blocking the feed load
  </action>
  <verify>
Run `npx tsc --noEmit` to verify all components compile. Check that:
- PostCard handles both locked and unlocked states
- UnlockDialog shows balance comparison and placeholder buttons
- Blur URL is used for locked media, presigned URLs for unlocked
- MuxPlayer receives playback tokens for gated video
  </verify>
  <done>
Locked posts show blurred media with lock overlay and Unlock button. Unlock dialog shows balance info and placeholder buy/burn buttons. Authorized viewers see content via presigned URLs/signed tokens. Text is always visible. No original URLs exposed to unauthorized viewers.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Gated content API at `/api/content/[postId]/media` correctly bifurcates authorized vs unauthorized responses
3. Unauthorized response contains only blur URLs — no original variant URLs or playback IDs
4. PostCard renders blurred placeholders with lock overlay for locked content
5. PostCard renders presigned/signed media for authorized viewers
6. UnlockDialog shows balance comparison and placeholder action buttons
7. Token balance API returns cached balance for a viewer + creator token pair
8. Post text is always visible regardless of gating status
</verification>

<success_criteria>
- Unauthorized viewers see blurred media with lock overlay and unlock prompt
- Authorized viewers see full content via time-limited signed URLs/tokens
- Unlock dialog provides clear information about gating requirements and viewer's balance
- Original media URLs never leak to unauthorized viewers
- All TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-token-gated-content/05-03-SUMMARY.md`
</output>
