---
phase: 09-discovery-notifications
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - lib/db/schema.ts
  - lib/discovery/search-actions.ts
  - app/(dashboard)/dashboard/explore/page.tsx
  - components/discovery/creator-search-results.tsx
autonomous: true

must_haves:
  truths:
    - "User can search for creators by name and get relevant results"
    - "Search supports prefix matching (autocomplete-style) for partial names"
    - "Search results show creator name, bio, avatar, and category"
    - "Search results link to the creator's trade page"
    - "Explore page at /dashboard/explore has a search bar and shows results"
  artifacts:
    - path: "lib/db/schema.ts"
      provides: "tsvector generated column and GIN index on creatorProfile"
      contains: "searchVector"
    - path: "lib/discovery/search-actions.ts"
      provides: "Server action for full-text creator search"
      exports: ["searchCreators"]
    - path: "app/(dashboard)/dashboard/explore/page.tsx"
      provides: "Explore page with search bar"
    - path: "components/discovery/creator-search-results.tsx"
      provides: "Search results list component"
  key_links:
    - from: "app/(dashboard)/dashboard/explore/page.tsx"
      to: "lib/discovery/search-actions.ts"
      via: "server action call"
      pattern: "searchCreators"
    - from: "components/discovery/creator-search-results.tsx"
      to: "/trade/{mintAddress}"
      via: "Link component"
      pattern: "Link.*trade"
---

<objective>
Add PostgreSQL full-text search to creator profiles using a generated `tsvector` column with a GIN index. Create an explore page at `/dashboard/explore` with a search bar that queries creators by name, bio, and category with prefix matching support.

Purpose: Fulfills DISC-02 (user can search for creators by name or category).
Output: Working explore page with full-text search, debounced input, and ranked results.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-discovery-notifications/09-RESEARCH.md
@.planning/phases/09-discovery-notifications/09-01-SUMMARY.md

Key existing files:
@lib/db/schema.ts — creatorProfile table (with category field added by 09-01)
@app/(dashboard)/layout.tsx — sidebar has Explore link to /dashboard/explore already
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tsvector generated column and GIN index to creatorProfile</name>
  <files>lib/db/schema.ts, lib/discovery/search-actions.ts</files>
  <action>
1. In `lib/db/schema.ts`, add a custom `tsvector` type using Drizzle's `customType`:
   ```typescript
   import { customType } from "drizzle-orm/pg-core";
   import { SQL, sql } from "drizzle-orm";

   const tsvector = customType<{ data: string }>({
     dataType() { return `tsvector`; },
   });
   ```
   Place this before the creatorProfile table definition.

2. Add a `searchVector` generated column to `creatorProfile`:
   ```typescript
   searchVector: tsvector("search_vector")
     .generatedAlwaysAs(
       (): SQL => sql`setweight(to_tsvector('simple', coalesce(${creatorProfile.displayName}, '')), 'A')
                      || setweight(to_tsvector('english', coalesce(${creatorProfile.bio}, '')), 'B')
                      || setweight(to_tsvector('simple', coalesce(${creatorProfile.category}, '')), 'C')`
     ),
   ```
   Place it at the end of the creatorProfile columns (after updatedAt). Use 'simple' config for displayName and category (no stemming on proper nouns), 'english' for bio.

3. Add a GIN index to the creatorProfile table. Convert the table definition to use the third argument form (same pattern as `contentUnlock`):
   ```typescript
   (table) => [
     // existing indexes if any...
     index("idx_creator_search").using("gin", sql`"search_vector"`),
   ]
   ```
   Import `index` from `drizzle-orm/pg-core` if not already imported.

4. Run `npx drizzle-kit generate` then `npx drizzle-kit push` to apply the migration.

5. Create `lib/discovery/search-actions.ts` with `"use server"` directive:
   - Export `searchCreators(query: string, limit: number = 20)`:
     - Sanitize input: remove special characters `query.replace(/[^\w\s]/g, '').trim()`
     - If empty after sanitization, return empty array
     - Split into words, build tsquery: full match on all words except last, prefix on last word (`:*`)
     - Join terms with ` & ` for AND semantics
     - Query: SELECT id, displayName, bio, avatarUrl, category from creatorProfile
     - JOIN with creatorToken to get mintAddress, tickerSymbol, tokenName, imageUrl
     - WHERE: `searchVector @@ to_tsquery('simple', tsquery)` AND `kycStatus = 'approved'`
     - ORDER BY: `ts_rank(searchVector, to_tsquery('simple', tsquery)) DESC`
     - LIMIT
     - Return `SearchResult[]` type (exported)
   - Use `sql` template for the tsvector/tsquery operations (Drizzle has no native tsvector operators)
  </action>
  <verify>
  - `npx drizzle-kit push` succeeds
  - `npx tsc --noEmit` passes
  </verify>
  <done>
  - creatorProfile has searchVector generated column with GIN index
  - searchCreators server action performs full-text search with prefix matching and relevance ranking
  </done>
</task>

<task type="auto">
  <name>Task 2: Create explore page with search UI</name>
  <files>app/(dashboard)/dashboard/explore/page.tsx, components/discovery/creator-search-results.tsx</files>
  <action>
1. Create `components/discovery/creator-search-results.tsx` ("use client"):
   - Receives `results: SearchResult[]` as prop
   - Renders a list of search result cards, each showing: avatar (or initial fallback), displayName, bio snippet (truncated), category badge, token ticker
   - Each card links to `/trade/${mintAddress}`
   - If results is empty and a search was performed, show "No creators found"
   - Reuse visual style from `CreatorBrowseCard` (09-01) or keep consistent styling

2. Create `app/(dashboard)/dashboard/explore/page.tsx`:
   - This must be a client component (`"use client"`) because it manages search input state
   - Search input at top: `<input>` with search icon (Search from lucide-react), placeholder "Search creators..."
   - Debounce search input: use `useCallback` + `setTimeout` with 300ms delay, clear previous timeout on each keystroke
   - On debounced value change, call `searchCreators(query)` server action and update results state
   - Show `CreatorSearchResults` below the search bar
   - Before any search: show a "Discover Creators" heading with a brief prompt ("Search by name, bio, or category")
   - While searching: show a simple loading state (can be opacity reduction or a spinner)
   - Use `useTransition` for the server action call to get isPending state
   - Empty query: clear results, show the initial prompt
  </action>
  <verify>
  - `npm run build` passes
  - Navigate to `/dashboard/explore` — search bar renders
  - Typing a query triggers search after 300ms debounce
  </verify>
  <done>
  - Explore page with working search bar at /dashboard/explore
  - Search results update as user types (debounced)
  - Results show relevant creators ranked by relevance
  - Prefix matching works (typing "Ale" matches "Alex")
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. `/dashboard/explore` renders with search bar
3. If creators exist, searching by partial name returns relevant results
4. GIN index exists on search_vector column (verify via migration)
</verification>

<success_criteria>
- Full-text search works with prefix matching on creator names (DISC-02)
- Search includes bio and category in ranking
- Explore page provides instant feedback as user types
- Results link to creator trade pages
</success_criteria>

<output>
After completion, create `.planning/phases/09-discovery-notifications/09-02-SUMMARY.md`
</output>
