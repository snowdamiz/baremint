---
phase: 09-discovery-notifications
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/discovery/leaderboard-actions.ts
  - app/(dashboard)/dashboard/leaderboard/page.tsx
  - components/discovery/leaderboard-table.tsx
  - app/(dashboard)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "User can view a token leaderboard page at /dashboard/leaderboard"
    - "Leaderboard shows tokens ranked by 24h trading volume"
    - "Leaderboard shows token name, ticker, creator name, volume, and trade count"
    - "User can sort by volume or newest"
    - "Leaderboard link is accessible from the dashboard sidebar navigation"
  artifacts:
    - path: "lib/discovery/leaderboard-actions.ts"
      provides: "Server action for leaderboard query with 24h volume aggregation"
      exports: ["getLeaderboard"]
    - path: "app/(dashboard)/dashboard/leaderboard/page.tsx"
      provides: "Leaderboard page with sorting controls"
    - path: "components/discovery/leaderboard-table.tsx"
      provides: "Leaderboard table component with sortable columns"
  key_links:
    - from: "app/(dashboard)/dashboard/leaderboard/page.tsx"
      to: "lib/discovery/leaderboard-actions.ts"
      via: "server action call"
      pattern: "getLeaderboard"
    - from: "app/(dashboard)/layout.tsx"
      to: "/dashboard/leaderboard"
      via: "sidebar nav link"
      pattern: "leaderboard"
---

<objective>
Create a token leaderboard page that ranks creator tokens by 24h trading volume using SQL aggregation on the existing `trade` table. Add a leaderboard link to the dashboard navigation.

Purpose: Fulfills DISC-03 (user can view token leaderboard ranked by market cap and trading volume). Market cap requires on-chain price data which is deferred to a cache update; for MVP, volume and trade count are the primary rankings.
Output: Working leaderboard page at /dashboard/leaderboard with volume-based rankings.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-discovery-notifications/09-RESEARCH.md

Key existing files:
@lib/db/schema.ts — trade table with solAmount, status, confirmedAt, creatorTokenId
@app/(dashboard)/layout.tsx — dashboard layout with sidebarItems array
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create leaderboard server action with 24h volume aggregation</name>
  <files>lib/discovery/leaderboard-actions.ts</files>
  <action>
1. Create `lib/discovery/leaderboard-actions.ts` with `"use server"` directive.

2. Export `getLeaderboard(sortBy: "volume_24h" | "newest" = "volume_24h", limit: number = 50, offset: number = 0)`:
   - Create a subquery that aggregates 24h volume from the `trade` table:
     - SELECT `creatorTokenId`, `SUM(CAST(solAmount AS NUMERIC))` as `volume24h`, `COUNT(*)` as `tradeCount`
     - WHERE `status = 'confirmed'` AND `confirmedAt > NOW() - INTERVAL '24 hours'`
     - GROUP BY `creatorTokenId`
     - Use Drizzle's `sql` template for the SUM and date arithmetic
   - Main query: JOIN `creatorToken` with `creatorProfile` (INNER JOIN, so only tokens with profiles show)
   - LEFT JOIN the volume subquery on `creatorTokenId`
   - SELECT: tokenId, mintAddress, tokenName, tickerSymbol, imageUrl, creatorName (displayName), creatorAvatarUrl, creatorProfileId, launchedAt, volume24h (COALESCE to '0'), tradeCount (COALESCE to 0)
   - ORDER BY: if `volume_24h` then `COALESCE(volume24h, '0') DESC`; if `newest` then `launchedAt DESC`
   - Use `limit + 1` for hasMore pagination
   - Return type: `{ tokens: LeaderboardItem[], hasMore: boolean }`
   - Export `LeaderboardItem` type

3. Use the exact pattern from the research file (Pattern 2: Leaderboard via SQL Aggregation), adapted for the actual schema column names. Reference existing SQL aggregation patterns from `app/trade/[token]/actions.ts`.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit` passes for this file</verify>
  <done>getLeaderboard server action returns paginated token rankings with 24h volume data</done>
</task>

<task type="auto">
  <name>Task 2: Create leaderboard page and add nav link</name>
  <files>app/(dashboard)/dashboard/leaderboard/page.tsx, components/discovery/leaderboard-table.tsx, app/(dashboard)/layout.tsx</files>
  <action>
1. Create `components/discovery/leaderboard-table.tsx` ("use client"):
   - Receives `initialTokens: LeaderboardItem[]` and `initialHasMore: boolean` as props
   - Renders a table/list with columns: Rank (#), Token (image + name + ticker), Creator (avatar + name), 24h Volume (formatted as SOL with 2 decimal places — divide lamports by 1e9), Trades (count)
   - Each row links to `/trade/${mintAddress}`
   - Volume display: convert lamports string to number, divide by 1e9, format with toFixed(2) + " SOL"
   - Rank: index + 1 + offset
   - Sort toggle buttons at the top: "Top Volume" | "Newest" — when clicked, call `getLeaderboard` with new sort param and replace data
   - Use `useTransition` for loading state during sort changes (matches existing pattern from trade forms)
   - Load More button at bottom if hasMore
   - Mobile responsive: on small screens, hide the Trades column, keep Volume

2. Create `app/(dashboard)/dashboard/leaderboard/page.tsx` (server component):
   - Import and call `getLeaderboard("volume_24h", 50, 0)` for initial data
   - Pass data to `LeaderboardTable` client component
   - Page title: "Leaderboard" with a trophy icon from lucide-react
   - If no tokens, show empty state: "No tokens launched yet"

3. Update `app/(dashboard)/layout.tsx`:
   - Add a leaderboard nav item to the `sidebarItems` array:
     ```
     { href: "/dashboard/leaderboard", icon: Trophy, label: "Leaderboard" }
     ```
   - Import `Trophy` from lucide-react
   - Place it after the Explore item in the array
  </action>
  <verify>
  - `npm run build` passes
  - Navigate to `/dashboard/leaderboard` — page renders with table or empty state
  - Sidebar shows Leaderboard link
  </verify>
  <done>
  - Leaderboard page renders at /dashboard/leaderboard with token rankings
  - Sort toggle switches between volume and newest
  - Navigation includes leaderboard link
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. `/dashboard/leaderboard` page renders correctly
3. Leaderboard link visible in sidebar and bottom nav
4. If trades exist, tokens are ranked by 24h volume; otherwise empty state
</verification>

<success_criteria>
- Token leaderboard page shows rankings by 24h volume (DISC-03)
- Users can sort by volume or newest
- Leaderboard accessible from dashboard navigation
- Volume calculated from confirmed trades via SQL aggregation
</success_criteria>

<output>
After completion, create `.planning/phases/09-discovery-notifications/09-03-SUMMARY.md`
</output>
