---
phase: 09-discovery-notifications
plan: 04
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - lib/db/schema.ts
  - lib/notifications/create.ts
  - app/api/notifications/route.ts
  - app/api/notifications/count/route.ts
  - app/api/webhooks/helius/route.ts
  - app/api/posts/[id]/publish/route.ts
  - components/notifications/notification-bell.tsx
  - components/notifications/notification-dropdown.tsx
  - components/notifications/notification-item.tsx
  - hooks/use-notification-count.ts
  - app/(dashboard)/layout.tsx
  - app/(dashboard)/dashboard/notifications/page.tsx
autonomous: true

must_haves:
  truths:
    - "User receives in-app notifications when creators they hold tokens for publish new content"
    - "User receives notifications for token activity (trades on tokens they hold)"
    - "Notification bell in the header shows unread count badge"
    - "User can view a list of all notifications at /dashboard/notifications"
    - "User can mark notifications as read"
    - "Notifications are deduplicated by txSignature for webhook-triggered events"
  artifacts:
    - path: "lib/db/schema.ts"
      provides: "notification table with indexes"
      contains: "notification"
    - path: "lib/notifications/create.ts"
      provides: "Server-side helper to fan out notifications to token holders"
      exports: ["notifyTokenHolders", "notifyTokenHoldersByCreator"]
    - path: "app/api/notifications/route.ts"
      provides: "GET notifications list, PATCH mark as read"
      exports: ["GET", "PATCH"]
    - path: "app/api/notifications/count/route.ts"
      provides: "GET unread notification count"
      exports: ["GET"]
    - path: "components/notifications/notification-bell.tsx"
      provides: "Bell icon with unread badge for header"
    - path: "hooks/use-notification-count.ts"
      provides: "Polling hook for notification count"
  key_links:
    - from: "app/api/webhooks/helius/route.ts"
      to: "lib/notifications/create.ts"
      via: "function call after trade confirmation"
      pattern: "notifyTokenHolders"
    - from: "app/api/posts/[id]/publish/route.ts"
      to: "lib/notifications/create.ts"
      via: "function call after post publish"
      pattern: "notifyTokenHoldersByCreator"
    - from: "components/notifications/notification-bell.tsx"
      to: "app/api/notifications/count/route.ts"
      via: "polling fetch"
      pattern: "api/notifications/count"
    - from: "app/(dashboard)/layout.tsx"
      to: "components/notifications/notification-bell.tsx"
      via: "component in header area"
      pattern: "NotificationBell"
---

<objective>
Build a complete in-app notification system: a notification database table, server-side fan-out to token holders on trade confirmations and content publishes, API routes for fetching and managing notifications, a polling-based unread count with header bell icon, and a full notifications page.

Purpose: Fulfills DISC-04 (notifications for new content from held creators) and DISC-05 (notifications for token activity).
Output: Working notification system with bell badge, dropdown, full page, and automatic notification creation on trades and posts.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-discovery-notifications/09-RESEARCH.md

Key existing files:
@lib/db/schema.ts — all tables including trade, post, creatorToken, creatorProfile
@app/api/webhooks/helius/route.ts — Helius webhook handler that confirms trades
@app/api/posts/[id]/publish/route.ts — Post publish endpoint
@app/(dashboard)/layout.tsx — dashboard layout where notification bell will go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Notification schema, creation helper, and API routes</name>
  <files>lib/db/schema.ts, lib/notifications/create.ts, app/api/notifications/route.ts, app/api/notifications/count/route.ts</files>
  <action>
1. In `lib/db/schema.ts`, add the notification table at the end (after donation table section):
   ```typescript
   // ──────────────────────────────────────────────
   // Notification tables (Phase 9)
   // ──────────────────────────────────────────────

   export const notification = pgTable("notification", {
     id: text("id").primaryKey(),
     userId: text("user_id").notNull().references(() => user.id),
     type: text("type").notNull(), // "new_content" | "trade_buy" | "trade_sell" | "token_burn"
     title: text("title").notNull(),
     body: text("body"),
     linkUrl: text("link_url"),
     relatedMintAddress: text("related_mint_address"),
     txSignature: text("tx_signature"), // for deduplication of webhook-triggered notifications
     isRead: boolean("is_read").notNull().default(false),
     createdAt: timestamp("created_at").notNull().defaultNow(),
   }, (table) => [
     index("idx_notification_user_unread").on(table.userId, table.isRead),
     index("idx_notification_tx_sig").on(table.txSignature),
   ]);
   ```
   Import `index` from `drizzle-orm/pg-core` if not already imported.

2. Run `npx drizzle-kit generate` then `npx drizzle-kit push`.

3. Create `lib/notifications/create.ts`:
   - `notifyTokenHolders(mintAddress: string, type: string, excludeUserId: string, title: string, body: string, txSignature?: string)`:
     - First, if txSignature provided, check if notification with this txSignature already exists: `SELECT 1 FROM notification WHERE tx_signature = ? LIMIT 1`. If exists, return early (deduplication).
     - Query distinct holders: `SELECT DISTINCT userId FROM trade WHERE mintAddress = ? AND type = 'buy' AND status = 'confirmed'`
     - Filter out excludeUserId
     - Cap at 1000 holders (LIMIT 1000 on the holders query)
     - Batch insert notifications using `db.insert(notification).values(notifications)`
     - Each notification: id = crypto.randomUUID(), linkUrl = `/trade/${mintAddress}`, relatedMintAddress = mintAddress
   - `notifyTokenHoldersByCreator(creatorProfileId: string, title: string, body: string, linkUrl: string)`:
     - Look up the creator's token: `SELECT mintAddress FROM creatorToken WHERE creatorProfileId = ?`
     - If no token, return early
     - Look up the creator's userId: `SELECT userId FROM creatorProfile WHERE id = ?`
     - Call `notifyTokenHolders` with type "new_content", excluding the creator's own userId, no txSignature

4. Create `app/api/notifications/count/route.ts`:
   - GET: Authenticate via `auth.api.getSession`, return 401 if not authenticated
   - Query: `SELECT COUNT(*) FROM notification WHERE userId = ? AND isRead = false`
   - Return: `{ count: number }`

5. Create `app/api/notifications/route.ts`:
   - GET: Authenticate, query notifications for user ordered by createdAt DESC, LIMIT 50 (support `?offset=` query param)
   - Return: `{ notifications: Notification[], hasMore: boolean }`
   - PATCH: Authenticate, accept `{ ids: string[] }` body, update `isRead = true` for those notification IDs where userId matches authenticated user
   - Return: `{ updated: number }`
  </action>
  <verify>
  - `npx drizzle-kit push` succeeds
  - `npx tsc --noEmit` passes
  </verify>
  <done>
  - notification table exists with proper indexes
  - notifyTokenHolders creates deduplicated notifications for token holders
  - API routes return notification count and list for authenticated users
  - Notifications can be marked as read
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire notification creation into webhooks and publish, add bell UI</name>
  <files>app/api/webhooks/helius/route.ts, app/api/posts/[id]/publish/route.ts, components/notifications/notification-bell.tsx, components/notifications/notification-dropdown.tsx, components/notifications/notification-item.tsx, hooks/use-notification-count.ts, app/(dashboard)/layout.tsx, app/(dashboard)/dashboard/notifications/page.tsx</files>
  <action>
1. Update `app/api/webhooks/helius/route.ts`:
   - Import `notifyTokenHolders` from `lib/notifications/create`
   - After successfully confirming a trade (status = "confirmed"), look up the trade details:
     ```typescript
     const [confirmedTrade] = await db.select({
       userId: trade.userId,
       mintAddress: trade.mintAddress,
       type: trade.type,
       solAmount: trade.solAmount,
       txSignature: trade.txSignature,
     }).from(trade).where(eq(trade.id, pendingTrade.id)).limit(1);
     ```
   - If confirmedTrade found, call:
     ```typescript
     await notifyTokenHolders(
       confirmedTrade.mintAddress,
       confirmedTrade.type === 'buy' ? 'trade_buy' : 'trade_sell',
       confirmedTrade.userId,
       confirmedTrade.type === 'buy' ? 'New token purchase' : 'Token sold',
       `Someone ${confirmedTrade.type === 'buy' ? 'bought' : 'sold'} tokens`,
       confirmedTrade.txSignature,
     );
     ```
   - Wrap in try/catch so notification failure doesn't affect trade confirmation (non-fatal)

2. Update `app/api/posts/[id]/publish/route.ts`:
   - Import `notifyTokenHoldersByCreator` from `lib/notifications/create`
   - After successful `publishPost()` call, invoke:
     ```typescript
     await notifyTokenHoldersByCreator(
       profile.id,
       'New post from ' + profile.displayName,
       published.content?.substring(0, 100) || 'Check out their latest post',
       `/dashboard/creator/${profile.id}`,
     ).catch(err => console.error('Notification fan-out error:', err));
     ```
   - Use `.catch()` to make it non-blocking/non-fatal

3. Create `hooks/use-notification-count.ts` ("use client"):
   - Export `useNotificationCount()` hook
   - `useState(0)` for count
   - `useCallback` for fetchCount that calls `GET /api/notifications/count` and updates state
   - `useEffect` to set up polling: call immediately, then setInterval with jitter (25-35 seconds: `30000 + Math.random() * 10000 - 5000`)
   - Cleanup interval on unmount
   - Return `{ count, refresh: fetchCount }`

4. Create `components/notifications/notification-item.tsx`:
   - Renders a single notification: icon (based on type), title, body, relative time, read/unread styling
   - Type icons: Bell for new_content, ArrowUpCircle for trade_buy, ArrowDownCircle for trade_sell (from lucide-react)
   - Unread: slightly highlighted background (bg-primary/5), read: normal background
   - Links to linkUrl if present

5. Create `components/notifications/notification-dropdown.tsx` ("use client"):
   - Fetches recent notifications from `GET /api/notifications?limit=10` on open
   - Shows list of NotificationItem components
   - "Mark all as read" button at top that calls `PATCH /api/notifications` with all unread IDs
   - "View all" link at bottom that goes to `/dashboard/notifications`
   - Triggered by clicking the bell icon (use a popover pattern: absolute positioned dropdown)

6. Create `components/notifications/notification-bell.tsx` ("use client"):
   - Uses `useNotificationCount` hook
   - Renders Bell icon from lucide-react
   - If count > 0, shows a red badge with the count (max display "99+")
   - On click, toggles `NotificationDropdown` visibility
   - Badge: absolute positioned small red circle with white text

7. Update `app/(dashboard)/layout.tsx`:
   - Add a header bar to the main content area (above children) or integrate the notification bell into the sidebar logo area
   - Best approach: Add the `NotificationBell` component in the sidebar header (next to the Baremint logo) for desktop, and in a fixed top-right position for mobile
   - Import and render `<NotificationBell />` in the logo/header area of the sidebar

8. Create `app/(dashboard)/dashboard/notifications/page.tsx`:
   - Client component that loads full notification list via `GET /api/notifications`
   - Renders all notifications using `NotificationItem`
   - Load more button for pagination
   - "Mark all as read" button
   - Page title: "Notifications" with Bell icon
   - Add a nav item in `sidebarItems` in layout.tsx: `{ href: "/dashboard/notifications", icon: Bell, label: "Notifications" }` -- place it after Leaderboard
  </action>
  <verify>
  - `npm run build` passes
  - Notification bell visible in dashboard layout
  - `/dashboard/notifications` page renders
  - Helius webhook and post publish routes include notification fan-out calls
  </verify>
  <done>
  - Trade confirmations trigger notifications to token holders (DISC-05)
  - Post publishes trigger notifications to token holders (DISC-04)
  - Notification bell with unread badge in dashboard header
  - Dropdown shows recent notifications
  - Full notifications page at /dashboard/notifications
  - Mark as read functionality works
  - Deduplication via txSignature prevents duplicate notifications
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. Notification bell visible in dashboard sidebar
3. `/dashboard/notifications` page renders
4. Helius webhook handler includes notification fan-out after trade confirmation
5. Post publish route includes notification fan-out after successful publish
6. Notification count endpoint returns unread count for authenticated user
</verification>

<success_criteria>
- In-app notifications created when creators publish content (DISC-04)
- In-app notifications created when trades happen on held tokens (DISC-05)
- Notification bell shows unread count with polling (30s with jitter)
- Full notification list page with mark-as-read
- Notifications deduplicated by txSignature
- Fan-out capped at 1000 holders for MVP
</success_criteria>

<output>
After completion, create `.planning/phases/09-discovery-notifications/09-04-SUMMARY.md`
</output>
