---
phase: 04-content-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/schema.ts
  - app/api/posts/route.ts
  - app/api/posts/[id]/route.ts
  - app/api/posts/[id]/publish/route.ts
  - lib/content/post-queries.ts
autonomous: true

must_haves:
  truths:
    - "Post and media tables exist in database with status-driven fields"
    - "Creator can create a draft post via API"
    - "Creator can save/update draft text with debounced auto-save"
    - "Creator can publish a text-only post that transitions to published status"
    - "Posts list API returns only published posts for public, drafts for owner"
  artifacts:
    - path: "lib/db/schema.ts"
      provides: "post, media, moderationAction, creatorStrike tables"
      contains: "export const post"
    - path: "app/api/posts/route.ts"
      provides: "POST create draft, GET list posts"
      exports: ["POST", "GET"]
    - path: "app/api/posts/[id]/route.ts"
      provides: "GET single post, PATCH update draft, DELETE post"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "app/api/posts/[id]/publish/route.ts"
      provides: "POST publish a post"
      exports: ["POST"]
    - path: "lib/content/post-queries.ts"
      provides: "Reusable query functions for posts"
  key_links:
    - from: "app/api/posts/route.ts"
      to: "lib/db/schema.ts"
      via: "drizzle query on post table"
      pattern: "db\\.select.*post|db\\.insert.*post"
    - from: "app/api/posts/[id]/publish/route.ts"
      to: "lib/db/schema.ts"
      via: "status transition draft->published"
      pattern: "status.*published"
---

<objective>
Create the content data model (post, media, moderation, strike tables) and text post CRUD API with draft auto-save and publish flow.

Purpose: This is the foundation for all content features. Every other plan in this phase depends on these tables and the post API.
Output: Database schema with status-driven content pipeline, working post CRUD endpoints, draft save/update capability, and publish transition logic.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-content-infrastructure/04-RESEARCH.md
@lib/db/schema.ts
@lib/storage/upload.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add content tables to database schema</name>
  <files>lib/db/schema.ts</files>
  <action>
Add four new tables to the existing schema.ts file under a new "Content tables (Phase 4)" section:

1. **post** table:
   - id: text PK
   - creatorProfileId: text FK to creatorProfile.id, notNull
   - content: text (nullable - posts can be media-only)
   - status: text notNull default "draft" (values: draft | processing | published | under_review | removed)
   - publishedAt: timestamp (nullable)
   - createdAt: timestamp notNull defaultNow
   - updatedAt: timestamp notNull defaultNow

2. **media** table:
   - id: text PK
   - postId: text FK to post.id (nullable - media can exist before being attached to a post)
   - creatorProfileId: text FK to creatorProfile.id, notNull
   - type: text notNull (image | video)
   - status: text notNull default "uploading" (values: uploading | scanning | processing | ready | flagged | failed)
   - originalKey: text (R2 key for original file)
   - variants: jsonb (nullable - for image responsive sizes: { sm: url, md: url, lg: url })
   - muxAssetId: text (nullable, video only)
   - muxPlaybackId: text (nullable, video only)
   - muxUploadId: text (nullable, video only)
   - duration: integer (nullable, seconds, video only)
   - width: integer (nullable)
   - height: integer (nullable)
   - mimeType: text (nullable)
   - fileSize: integer (nullable, bytes)
   - sortOrder: integer notNull default 0
   - createdAt: timestamp notNull defaultNow

3. **moderationAction** table:
   - id: text PK
   - mediaId: text FK to media.id (nullable)
   - postId: text FK to post.id (nullable)
   - action: text notNull (flag_csam | approve | reject | remove)
   - reason: text (nullable - hash_match | classifier | manual)
   - confidence: text (nullable - CSAM classifier score as string)
   - reviewedBy: text FK to user.id (nullable - admin who reviewed)
   - reviewedAt: timestamp (nullable)
   - createdAt: timestamp notNull defaultNow

4. **creatorStrike** table:
   - id: text PK
   - creatorProfileId: text FK to creatorProfile.id, notNull
   - moderationActionId: text FK to moderationAction.id, notNull
   - strikeNumber: integer notNull (1, 2, or 3)
   - consequence: text notNull (warning | restriction | suspension)
   - reason: text notNull
   - createdAt: timestamp notNull defaultNow

Import `jsonb` from drizzle-orm/pg-core (add to the existing import).

Run `npx drizzle-kit push` to apply schema changes.
  </action>
  <verify>Run `npx drizzle-kit push` completes without errors. Run `npx tsx -e "import { post, media, moderationAction, creatorStrike } from './lib/db/schema'; console.log('Schema OK')"` to verify exports.</verify>
  <done>Four new tables exist in database. Schema file exports post, media, moderationAction, creatorStrike. All FKs reference correct parent tables.</done>
</task>

<task type="auto">
  <name>Task 2: Create post CRUD API with draft auto-save and publish</name>
  <files>
    app/api/posts/route.ts
    app/api/posts/[id]/route.ts
    app/api/posts/[id]/publish/route.ts
    lib/content/post-queries.ts
  </files>
  <action>
Create a reusable query module and three API route files:

**lib/content/post-queries.ts:**
- `createDraftPost(creatorProfileId: string, content?: string)` - inserts post with status "draft", generates UUID id, returns the post
- `updateDraftPost(postId: string, creatorProfileId: string, content: string)` - updates content and updatedAt WHERE status = "draft" AND creatorProfileId matches. Returns updated post or null if not found/not draft.
- `publishPost(postId: string, creatorProfileId: string)` - transitions post to "published" status, sets publishedAt to now(). ONLY if current status is "draft" AND post has no media (text-only for now). Returns updated post or null.
- `getPublishedPosts(creatorProfileId: string, limit: number, offset: number)` - returns published posts ordered by publishedAt desc. Include count of attached media per post.
- `getCreatorDrafts(creatorProfileId: string)` - returns draft posts ordered by updatedAt desc
- `getPostById(postId: string)` - returns single post with its media records
- `deletePost(postId: string, creatorProfileId: string)` - soft delete: sets status to "removed" WHERE creatorProfileId matches. Does NOT hard-delete (legal compliance).

**app/api/posts/route.ts:**
- POST: Create a new draft post. Requires auth (use Better Auth session from headers). Look up creatorProfile by userId. Accept `{ content?: string }`. Return 201 with post object.
- GET: List posts. Accept query params: `creatorProfileId` (required), `status` (optional, default "published"), `limit` (default 20, max 50), `offset` (default 0). If status=draft, verify the requester owns the profile. Return posts array with total count.

**app/api/posts/[id]/route.ts:**
- GET: Return single post with media. Published posts visible to all. Draft/processing posts visible only to owner.
- PATCH: Update draft content. Accept `{ content: string }`. Only works on drafts owned by requester. This is the auto-save endpoint. Return updated post.
- DELETE: Soft-delete post. Only owner can delete. Sets status to "removed".

**app/api/posts/[id]/publish/route.ts:**
- POST: Publish a post. For text-only posts (no media), transition directly to "published". For posts with media, transition to "processing" and check if all media is "ready" -- if so, transition to "published". If any media is not ready, keep as "processing". Return updated post.

Auth pattern: Use the same Better Auth session checking pattern from existing API routes (check `app/api/creator/` for the pattern). Return 401 if not authenticated, 403 if not the post owner.

Use Zod for input validation. Generate IDs with `crypto.randomUUID()`.
  </action>
  <verify>Run `npm run build` to verify no TypeScript errors. Test with curl:
- `curl -X POST /api/posts -H "Content-Type: application/json" -d '{"content":"test"}' --cookie session` returns 201
- `curl /api/posts?creatorProfileId=xxx&status=draft --cookie session` returns drafts
- `curl -X PATCH /api/posts/xxx -d '{"content":"updated"}' --cookie session` returns updated post
- `curl -X POST /api/posts/xxx/publish --cookie session` returns published post
  </verify>
  <done>Post CRUD API works: create draft returns 201, update draft saves content, publish transitions text-only posts to "published", GET returns published posts publicly and drafts to owner only, DELETE soft-removes posts. All endpoints require auth and verify ownership.</done>
</task>

</tasks>

<verification>
- `npx drizzle-kit push` succeeds with all 4 new tables
- `npm run build` passes with no type errors
- POST /api/posts creates a draft
- PATCH /api/posts/[id] updates draft content
- POST /api/posts/[id]/publish transitions to published
- GET /api/posts returns published posts
- DELETE /api/posts/[id] soft-deletes
</verification>

<success_criteria>
- Schema has post, media, moderationAction, creatorStrike tables with correct status fields
- Post CRUD API supports full draft -> publish lifecycle for text-only posts
- Auth and ownership checks on all endpoints
- Publish endpoint handles both text-only (immediate) and media posts (check media status)
</success_criteria>

<output>
After completion, create `.planning/phases/04-content-infrastructure/04-01-SUMMARY.md`
</output>
