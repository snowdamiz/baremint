---
phase: 04-content-infrastructure
plan: 05
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - app/api/posts/[id]/route.ts
  - app/api/admin/moderation/route.ts
  - app/api/admin/moderation/[id]/route.ts
  - components/admin/moderation-queue.tsx
  - app/(dashboard)/dashboard/admin/moderation/page.tsx
  - lib/content/post-queries.ts
  - lib/content/moderation.ts
autonomous: true

must_haves:
  truths:
    - "Creator can edit text of their own published post"
    - "Creator can delete their own post (soft delete)"
    - "Flagged content shows 'Under review' to creator only"
    - "Admin can view moderation queue with flagged content"
    - "Admin can approve or reject flagged content"
    - "Rejection creates a strike against the creator"
    - "Third strike suspends the creator account"
  artifacts:
    - path: "app/api/posts/[id]/route.ts"
      provides: "PATCH for editing published post text, DELETE for soft delete (extended)"
    - path: "app/api/admin/moderation/route.ts"
      provides: "GET moderation queue (flagged items)"
      exports: ["GET"]
    - path: "app/api/admin/moderation/[id]/route.ts"
      provides: "POST approve/reject a flagged item"
      exports: ["POST"]
    - path: "components/admin/moderation-queue.tsx"
      provides: "Admin UI for reviewing flagged content"
    - path: "app/(dashboard)/dashboard/admin/moderation/page.tsx"
      provides: "Admin moderation page"
    - path: "lib/content/moderation.ts"
      provides: "Strike system logic with 3-strike threshold"
  key_links:
    - from: "app/api/admin/moderation/[id]/route.ts"
      to: "lib/content/moderation.ts"
      via: "calls issueStrike on rejection"
      pattern: "issueStrike"
    - from: "lib/content/moderation.ts"
      to: "lib/db/schema.ts"
      via: "creates creatorStrike records, checks count for suspension"
      pattern: "creatorStrike|creatorProfile.*kycStatus"
---

<objective>
Implement post editing/deletion for creators, and the admin moderation queue with strike system for handling CSAM-flagged content.

Purpose: Creators need content management (edit, delete). The moderation pipeline needs a human review layer for flagged content with consequences (strikes, suspension) for confirmed violations.
Output: Working post edit/delete API, admin moderation queue UI, approve/reject flow, and 3-strike suspension system.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-content-infrastructure/04-RESEARCH.md
@.planning/phases/04-content-infrastructure/04-01-SUMMARY.md
@.planning/phases/04-content-infrastructure/04-02-SUMMARY.md
@lib/db/schema.ts
@lib/content/post-queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend post edit/delete API and create moderation logic</name>
  <files>
    app/api/posts/[id]/route.ts
    lib/content/post-queries.ts
    lib/content/moderation.ts
  </files>
  <action>
**Extend app/api/posts/[id]/route.ts - PATCH handler:**
The PATCH handler from Plan 01 updates drafts. Extend it to also handle editing published posts:
- Accept `{ content: string }` for published posts (only text is editable, not media)
- Update content and updatedAt. Do NOT change publishedAt.
- Only owner can edit. Verify creatorProfileId matches.
- Posts with status "under_review" or "removed" cannot be edited.

**Extend lib/content/post-queries.ts:**
- Add `updatePublishedPost(postId: string, creatorProfileId: string, content: string)` - updates content WHERE status IN ("draft", "published") AND creatorProfileId matches
- Ensure `deletePost` properly handles cascade: when a post is soft-deleted (status = "removed"), also update all attached media to not be publicly queryable (but don't delete from R2 -- legal compliance)

**lib/content/moderation.ts:**
Create the moderation and strike system:

`getModerQueue(limit: number, offset: number)`:
- Query moderationAction records with action = "flag_csam" that have NOT been reviewed (reviewedAt IS NULL)
- Join with media and post tables to get full context
- Return flagged items with creator info, media details, post content
- Order by createdAt asc (oldest first)

`approveContent(moderationActionId: string, adminUserId: string)`:
- Update moderationAction: action = "approve", reviewedBy = adminUserId, reviewedAt = now()
- Update associated media status from "flagged" to "ready"
- If the post was "under_review", check if all media is now ready -> transition post to "published"
- Return updated records

`rejectContent(moderationActionId: string, adminUserId: string, reason: string)`:
- Update moderationAction: action = "reject", reviewedBy = adminUserId, reviewedAt = now()
- Update associated media status to "failed" (cannot be recovered)
- Update associated post status to "removed"
- Call `issueStrike` for the creator

`issueStrike(creatorProfileId: string, moderationActionId: string, reason: string)`:
- Count existing strikes for this creator
- Create creatorStrike record with strikeNumber = existingCount + 1
- Determine consequence based on 3-strike system (per RESEARCH.md):
  - Strike 1: consequence = "warning" (post removed, creator notified)
  - Strike 2: consequence = "restriction" (7-day posting restriction -- set a field on creatorProfile)
  - Strike 3: consequence = "suspension" (account suspended -- set creatorProfile.kycStatus to "suspended" or add a `suspended` boolean)
- Return the strike with consequence

`getCreatorStrikes(creatorProfileId: string)`:
- Return all strikes for a creator, ordered by createdAt

`isCreatorRestricted(creatorProfileId: string)`:
- Check if creator has an active restriction (strike 2 within last 7 days) or is suspended (strike 3+)
- Used by post creation API to prevent restricted creators from posting

Add a `suspendedAt` column to creatorProfile schema if needed, or reuse kycStatus with a "suspended" value.
  </action>
  <verify>Run `npm run build` to verify no TypeScript errors. Run `npx tsx -e "import { getModerQueue, approveContent, rejectContent, issueStrike } from './lib/content/moderation'; console.log('Moderation OK')"` to verify exports.</verify>
  <done>Post edit works for published posts (text only). Soft delete marks post as "removed". Moderation module provides queue query, approve/reject with media/post status updates, and 3-strike system (warning -> restriction -> suspension).</done>
</task>

<task type="auto">
  <name>Task 2: Create admin moderation API and queue UI</name>
  <files>
    app/api/admin/moderation/route.ts
    app/api/admin/moderation/[id]/route.ts
    components/admin/moderation-queue.tsx
    app/(dashboard)/dashboard/admin/moderation/page.tsx
  </files>
  <action>
**app/api/admin/moderation/route.ts:**
- GET: Return moderation queue. Query params: limit (default 20), offset (default 0).
- Auth check: require authenticated user. Admin check: for MVP, check if user email matches an ADMIN_EMAILS env var (comma-separated list). Return 403 if not admin.
- Call `getModerQueue(limit, offset)` and return results with total count.

**app/api/admin/moderation/[id]/route.ts:**
- POST: Approve or reject a flagged item.
- Accept `{ action: "approve" | "reject", reason?: string }`
- Auth check: admin only (same check as above)
- If action = "approve": call `approveContent(id, adminUserId)`
- If action = "reject": call `rejectContent(id, adminUserId, reason)` -- reason required for rejections
- Return updated moderation action with strike info if applicable

**components/admin/moderation-queue.tsx:**
Create the admin review interface:
- Fetch from GET /api/admin/moderation
- Display each flagged item as a card showing:
  - Media preview (image thumbnail or video still -- for flagged content, show with a warning overlay/blur by default, click to reveal)
  - Flag reason: "Hash match (known CSAM)" or "AI classifier (confidence: X%)"
  - Post content (text) if attached to a post
  - Creator info (display name, profile link, current strike count)
  - Timestamp of flag
- Action buttons per item: "Approve" (green) and "Reject" (red)
- Reject requires a reason input (text field or dropdown: "CSAM confirmed", "Policy violation", "Other")
- After action, remove item from queue and show toast notification (sonner)
- Empty state: "No items pending review"
- Pagination with "Load more" button

**app/(dashboard)/dashboard/admin/moderation/page.tsx:**
- Simple page wrapper that renders ModerationQueue component
- Title: "Content Moderation"
- Protected: redirect to dashboard if not admin

Style with Tailwind and shadcn components, consistent with existing dashboard pages.
  </action>
  <verify>Run `npm run build` to verify no TypeScript errors. Run `npm run dev` and navigate to /dashboard/admin/moderation (as admin) to verify the page renders.</verify>
  <done>Admin moderation API returns flagged queue items and handles approve/reject actions. Admin UI shows flagged content with media preview (blurred), flag details, creator info, and approve/reject buttons. Rejection issues strikes with 3-strike consequences. Restricted/suspended creators cannot create new posts.</done>
</task>

</tasks>

<verification>
- `npm run build` passes
- PATCH /api/posts/[id] edits published post text
- DELETE /api/posts/[id] soft-deletes (status = "removed")
- GET /api/admin/moderation returns flagged items (admin only)
- POST /api/admin/moderation/[id] approves or rejects with correct status transitions
- Rejection creates a strike, 3rd strike suspends creator
- Admin UI renders queue with media previews and action buttons
</verification>

<success_criteria>
- Creators can edit post text and delete posts
- Admin moderation queue shows flagged content with context
- Approve restores content, reject removes it and issues strike
- 3-strike system: warning -> restriction -> suspension
- Restricted creators cannot create new posts
</success_criteria>

<output>
After completion, create `.planning/phases/04-content-infrastructure/04-05-SUMMARY.md`
</output>
