---
phase: 04-content-infrastructure
plan: 04
type: execute
wave: 3
depends_on: ["04-01", "04-02", "04-03"]
files_modified:
  - components/content/post-composer.tsx
  - components/content/media-upload.tsx
  - components/content/video-upload.tsx
  - components/content/post-card.tsx
  - components/content/post-feed.tsx
  - app/(dashboard)/creator/[slug]/page.tsx
autonomous: false

must_haves:
  truths:
    - "Creator can open a modal composer and write a text post"
    - "Creator can attach images to a post with upload progress"
    - "Creator can attach a video to a post with upload progress and processing state"
    - "Creator can publish a post and see it in their profile feed"
    - "Draft auto-saves every 10 seconds while typing"
    - "Published posts display with truncated text, full-width images, and video thumbnails"
    - "Creator can access their drafts list"
  artifacts:
    - path: "components/content/post-composer.tsx"
      provides: "Modal composer with text input, media attachment, draft auto-save, publish button"
      min_lines: 100
    - path: "components/content/media-upload.tsx"
      provides: "Image upload component with progress bar and preview"
    - path: "components/content/video-upload.tsx"
      provides: "MuxUploader wrapper with progress and processing state"
    - path: "components/content/post-card.tsx"
      provides: "Post display card with text truncation, images, video player"
      min_lines: 60
    - path: "components/content/post-feed.tsx"
      provides: "Vertical feed of post cards with pagination"
    - path: "app/(dashboard)/creator/[slug]/page.tsx"
      provides: "Creator profile page with post feed"
  key_links:
    - from: "components/content/post-composer.tsx"
      to: "/api/posts"
      via: "fetch to create draft, save draft, publish"
      pattern: "fetch.*api/posts"
    - from: "components/content/media-upload.tsx"
      to: "/api/upload/presign"
      via: "fetch to get presigned URL, then PUT to R2, then confirm"
      pattern: "fetch.*api/upload/presign|fetch.*api/media"
    - from: "components/content/video-upload.tsx"
      to: "/api/upload/video"
      via: "fetch to get R2 URL, upload, confirm, then MuxUploader for transcoding"
      pattern: "MuxUploader|fetch.*api/upload/video"
    - from: "components/content/post-card.tsx"
      to: "@mux/mux-player-react"
      via: "renders MuxPlayer for video posts"
      pattern: "MuxPlayer"
---

<objective>
Build the post composer UI (modal with text + media), media upload components with progress indicators, and the post feed/card display for creator profiles.

Purpose: This is the user-facing content creation and display layer. Creators need to write posts, attach media, see upload progress, and view published content on their profile.
Output: Working composer modal, image/video upload with progress, post cards with text/image/video rendering, and profile feed.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-content-infrastructure/04-RESEARCH.md
@.planning/phases/04-content-infrastructure/04-01-SUMMARY.md
@.planning/phases/04-content-infrastructure/04-02-SUMMARY.md
@.planning/phases/04-content-infrastructure/04-03-SUMMARY.md
@components/creator/onboarding-wizard.tsx
@app/(dashboard)/creator/[slug]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create post composer modal with media upload components</name>
  <files>
    components/content/post-composer.tsx
    components/content/media-upload.tsx
    components/content/video-upload.tsx
  </files>
  <action>
**components/content/post-composer.tsx:**
Create a modal/overlay post composer (per context decision: "Modal/overlay composer -- opens on top of current page"):
- Use shadcn Dialog component for the modal
- State: text content, attached media (array of { mediaId, type, status, previewUrl, variants?, muxUploadUrl? }), isDraft, isSaving, isPublishing
- Text input: plain text textarea (no rich text - context decision), auto-resize as content grows
- Auto-save draft: 10-second debounce after last text change. On first save, POST /api/posts to create draft. On subsequent saves, PATCH /api/posts/[id] with current content. Show subtle "Saved" / "Saving..." indicator.
- Media attachment buttons: "Add Image" and "Add Video" buttons below the textarea
- "Add Image" opens file picker (accept image/jpeg, image/png, image/webp, max 25MB). On select, renders MediaUpload component.
- "Add Video" opens file picker (accept video/mp4, video/quicktime). On select, renders VideoUpload component.
- Attached media preview area: show thumbnails/previews of attached media with status indicators and remove button
- Publish button: calls POST /api/posts/[id]/publish. Disabled while any media is not "ready". Shows "Publishing..." state.
- If any media is still processing, show "Media processing..." message near publish button
- Close button with confirmation if draft has unsaved changes
- Props: `isOpen: boolean, onClose: () => void, onPublished: (post) => void`

**components/content/media-upload.tsx:**
Image upload component with progress:
- Props: `onUploaded: (media: { mediaId, variants, previewUrl }) => void, onRemove: () => void, postId?: string`
- Flow:
  1. Call POST /api/upload/presign with contentType and purpose "post-media"
  2. PUT to presigned URL with XHR (not fetch) to track upload progress
  3. Show progress bar during upload (0-100%)
  4. On upload complete, call POST /api/media/[mediaId]/confirm
  5. Show "Scanning..." then "Processing..." states
  6. On confirm response with status "ready", show image preview using the `md` variant URL
  7. On confirm response with status "flagged", show error message "This image could not be processed"
- Show the image preview thumbnail once uploaded
- Remove button (X) to detach media

**components/content/video-upload.tsx:**
Video upload component wrapping Mux uploader:
- Props: `onUploaded: (media: { mediaId, muxPlaybackId }) => void, onRemove: () => void, postId?: string`
- Flow:
  1. Call POST /api/upload/video to get R2 presigned URL and mediaId
  2. Upload original to R2 via XHR with progress bar
  3. Call POST /api/media/[mediaId]/confirm to trigger CSAM scan
  4. If scan passes, response includes muxUploadUrl
  5. Render MuxUploader component with the muxUploadUrl for transcoding upload
  6. Show states: "Uploading to storage..." -> "Scanning..." -> "Uploading for processing..." -> "Processing..."
  7. Video is "ready" when Mux webhook fires (poll /api/posts/[id] or use media status check)
- For the processing state after Mux upload, poll GET /api/media/[mediaId] every 5 seconds to check status
- Show video thumbnail (from Mux) once ready
- Use dynamic import for MuxUploader to avoid SSR issues: `const MuxUploader = dynamic(() => import("@mux/mux-uploader-react"), { ssr: false })`

Style all components using Tailwind classes consistent with the existing design system.
  </action>
  <verify>Run `npm run build` to verify no TypeScript errors. Run `npm run dev` and verify the composer modal renders without console errors.</verify>
  <done>Post composer modal opens, accepts text input with auto-save, allows image and video attachments with progress indicators, and has a working publish button. Media upload components handle the full upload -> scan -> process flow with appropriate status states.</done>
</task>

<task type="auto">
  <name>Task 2: Create post card, feed, and creator profile integration</name>
  <files>
    components/content/post-card.tsx
    components/content/post-feed.tsx
    app/(dashboard)/creator/[slug]/page.tsx
  </files>
  <action>
**components/content/post-card.tsx:**
Post display card for the feed:
- Props: `post: Post & { media: Media[] }` (types from schema)
- Text display: show first ~300 characters, truncate with "Read more" link that expands inline (per context decision)
- Image display: full-width images within the post (per context decision). If multiple images, show them vertically stacked.
  - Use the `lg` variant for desktop, `md` for mobile via srcset or responsive CSS
  - Images use next/image with the R2 public URL
- Video display: show thumbnail with play button (per context decision: "Videos show thumbnail with play button -- click to play, no autoplay")
  - Use MuxPlayer with `playbackId` from media record
  - Dynamic import MuxPlayer to avoid SSR: `const MuxPlayer = dynamic(() => import("@mux/mux-player-react"), { ssr: false })`
  - Set `autoPlay={false}`, show poster/thumbnail
- Post metadata: creator avatar, display name, relative time (e.g., "2 hours ago")
- Status badges for creator's own view: "Draft" tag, "Processing" with spinner, "Under Review" with warning icon
- Use shadcn Card component as the container

**components/content/post-feed.tsx:**
Vertical feed of post cards:
- Props: `creatorProfileId: string, isOwner: boolean`
- Fetch posts from GET /api/posts?creatorProfileId=xxx&status=published (or include drafts if isOwner)
- Infinite scroll or "Load more" button with offset-based pagination (limit=20)
- Empty state: "No posts yet" for public view, "Create your first post" with button for owner view
- Loading skeleton cards while fetching
- If isOwner, show a "New Post" button at the top that opens the composer modal
- If isOwner, show a "Drafts" tab/section showing draft posts

**app/(dashboard)/creator/[slug]/page.tsx:**
Update (or create if needed) the creator profile page to include the post feed:
- This page likely already exists from Phase 3 (public creator profile)
- Add the PostFeed component below the existing profile header/info
- Determine isOwner by comparing session userId to the creator profile userId
- Pass creatorProfileId and isOwner to PostFeed
- Include the PostComposer modal (rendered but hidden until triggered)

Use Tailwind for styling. Follow the existing project's card/layout patterns from dashboard pages.
  </action>
  <verify>Run `npm run build` to verify no TypeScript errors. Run `npm run dev` and navigate to a creator profile page to verify the feed renders.</verify>
  <done>Post cards render text (truncated with "Read more"), full-width images (responsive variants), and video (MuxPlayer with thumbnail). Feed shows published posts with pagination and empty states. Creator profile page includes the feed and composer trigger. Owners see drafts and new post button.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete post creation and display flow: modal composer with text + image + video upload, progress indicators, auto-save drafts, CSAM scan pipeline, and post feed on creator profile.</what-built>
  <how-to-verify>
    1. Navigate to your creator profile page at /creator/[your-slug]
    2. Click "New Post" button - composer modal should open
    3. Type some text - after 10 seconds, should show "Saved" indicator (draft auto-save)
    4. Click "Add Image" and select a JPEG - should see upload progress bar, then processing, then image preview
    5. Click "Publish" - post should appear in the feed below with full-width image and text
    6. Verify text truncation: create a post with 400+ characters, should show "Read more"
    7. If video upload configured: attach a video, observe R2 upload -> scan -> Mux upload -> processing states
    8. Check drafts section shows unpublished posts
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` passes
- Post composer modal opens and closes properly
- Text auto-saves after 10-second debounce
- Image upload shows progress -> scanning -> processing -> ready
- Video upload shows progress -> scanning -> Mux upload -> processing
- Published posts display in feed with correct rendering
- Feed has pagination and empty states
- Creator profile page integrates feed and composer
</verification>

<success_criteria>
- Creator can write a text post, attach images/video, and publish
- Upload progress is visible for all media types
- Auto-save drafts work with 10-second debounce
- Published posts render with truncated text, full-width images, video thumbnails
- Feed is paginated and shows correct posts (published publicly, drafts to owner)
</success_criteria>

<output>
After completion, create `.planning/phases/04-content-infrastructure/04-04-SUMMARY.md`
</output>
