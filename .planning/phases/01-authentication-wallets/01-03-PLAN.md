---
phase: 01-authentication-wallets
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - lib/auth.ts
  - lib/auth-client.ts
  - lib/solana/transfer.ts
  - app/(auth)/auth/page.tsx
  - app/(auth)/auth/2fa/page.tsx
  - app/(dashboard)/dashboard/settings/page.tsx
  - app/(dashboard)/dashboard/withdraw/page.tsx
  - app/(dashboard)/dashboard/withdraw/review/page.tsx
  - components/auth/oauth-buttons.tsx
  - components/auth/auth-form.tsx
  - components/two-factor/setup-dialog.tsx
  - components/two-factor/verify-form.tsx
  - components/two-factor/backup-codes.tsx
  - components/withdraw/withdraw-form.tsx
  - components/withdraw/address-book.tsx
  - components/withdraw/review-card.tsx
autonomous: false

user_setup:
  - service: google-oauth
    why: "Google sign-in for users"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> same credential"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (Web application type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Add authorized redirect URI: {APP_URL}/api/auth/callback/google"
        location: "Same OAuth client config"
  - service: twitter-oauth
    why: "Twitter/X sign-in for users"
    env_vars:
      - name: TWITTER_CLIENT_ID
        source: "Twitter Developer Portal -> Project -> App -> Keys and tokens"
      - name: TWITTER_CLIENT_SECRET
        source: "Same page"
    dashboard_config:
      - task: "Create app with OAuth 2.0 enabled"
        location: "Twitter Developer Portal -> Projects & Apps"
      - task: "Add callback URL: {APP_URL}/api/auth/callback/twitter"
        location: "App settings -> Authentication settings"

must_haves:
  truths:
    - "User can sign up or log in via Google OAuth"
    - "User can sign up or log in via Twitter OAuth"
    - "User can enable TOTP 2FA from settings"
    - "2FA is required before first SOL withdrawal"
    - "2FA cannot be disabled once enabled"
    - "Recovery codes are shown once during 2FA setup"
    - "User can withdraw SOL to an external address with two-step confirmation"
    - "User can save and select withdrawal addresses from an address book"
  artifacts:
    - path: "components/auth/oauth-buttons.tsx"
      provides: "Google + Twitter OAuth sign-in buttons"
    - path: "app/(auth)/auth/2fa/page.tsx"
      provides: "2FA verification page during login"
    - path: "components/two-factor/setup-dialog.tsx"
      provides: "TOTP setup with QR code and backup codes"
    - path: "lib/solana/transfer.ts"
      provides: "SOL transfer transaction building and signing"
      exports: ["buildAndSendSolTransfer"]
    - path: "app/(dashboard)/dashboard/withdraw/page.tsx"
      provides: "Step 1: withdrawal details entry"
    - path: "app/(dashboard)/dashboard/withdraw/review/page.tsx"
      provides: "Step 2: withdrawal review and confirmation"
    - path: "components/withdraw/address-book.tsx"
      provides: "Saved address management"
  key_links:
    - from: "components/auth/oauth-buttons.tsx"
      to: "lib/auth-client.ts"
      via: "authClient.signIn.social()"
      pattern: "signIn\\.social"
    - from: "components/two-factor/setup-dialog.tsx"
      to: "lib/auth-client.ts"
      via: "authClient.twoFactor.enable()"
      pattern: "twoFactor\\.enable"
    - from: "app/(dashboard)/dashboard/withdraw/review/page.tsx"
      to: "lib/solana/transfer.ts"
      via: "Server action calling buildAndSendSolTransfer"
      pattern: "buildAndSendSolTransfer"
    - from: "withdraw flow"
      to: "2FA verification"
      via: "Require 2FA verification before executing withdrawal"
      pattern: "twoFactor\\.verify|verifyTotp"
---

<objective>
Add OAuth providers (Google + Twitter), TOTP 2FA with just-in-time enforcement, and the complete SOL withdrawal flow with address book and two-step confirmation.

Purpose: Completes all Phase 1 requirements -- users have full auth options (email, Google, Twitter), security via 2FA, and can withdraw SOL from their custodial wallet.
Output: OAuth login, 2FA setup/enforcement, withdrawal flow with address book and review step.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-authentication-wallets/01-RESEARCH.md
@.planning/phases/01-authentication-wallets/01-CONTEXT.md
@.planning/phases/01-authentication-wallets/01-01-SUMMARY.md
@.planning/phases/01-authentication-wallets/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: OAuth providers and 2FA setup</name>
  <files>
    lib/auth.ts
    lib/auth-client.ts
    components/auth/oauth-buttons.tsx
    components/auth/auth-form.tsx
    app/(auth)/auth/page.tsx
    app/(auth)/auth/2fa/page.tsx
    app/(dashboard)/dashboard/settings/page.tsx
    components/two-factor/setup-dialog.tsx
    components/two-factor/verify-form.tsx
    components/two-factor/backup-codes.tsx
  </files>
  <action>
    1. Update `lib/auth.ts` to add social providers:
       - Add socialProviders config with google and twitter
       - Use env vars for client IDs and secrets (GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, TWITTER_CLIENT_ID, TWITTER_CLIENT_SECRET)
       - Ensure the existing databaseHooks for wallet creation still fires for OAuth signups (verify the hook triggers on social provider account creation too -- if not, add explicit handling)

    2. Create `components/auth/oauth-buttons.tsx`:
       - Two buttons: "Continue with Google" and "Continue with Twitter"
       - Use authClient.signIn.social({ provider: "google" }) and same for twitter
       - Style with shadcn Button, include provider icons (use simple SVG icons inline or from a lightweight icon set)
       - Each button triggers the OAuth redirect flow

    3. Update `components/auth/auth-form.tsx`:
       - Add OAuthButtons component ABOVE the email input
       - Add "or" divider (horizontal line with "or" text centered) between OAuth buttons and email input
       - Layout: OAuth buttons -> divider -> email-first form (as designed in CONTEXT.md)

    4. Create `app/(auth)/auth/2fa/page.tsx`:
       - 2FA verification page shown during login when user has 2FA enabled
       - Uses the verify-form component
       - On successful verification, redirect to /dashboard
       - Better Auth's twoFactor client plugin handles the redirect to this page automatically via onTwoFactorRedirect

    5. Create `components/two-factor/verify-form.tsx`:
       - 6-digit code input (can be a single text input or 6 individual digit inputs)
       - "Verify" button calls authClient.twoFactor.verifyTotp({ code })
       - Link to "Use backup code instead" which shows a backup code input
       - Error handling for invalid codes

    6. Create `app/(dashboard)/dashboard/settings/page.tsx`:
       - Settings page with "Security" section
       - If 2FA not enabled: show "Enable Two-Factor Authentication" button that opens setup dialog
       - If 2FA enabled: show "Two-factor authentication is enabled" with a green checkmark. NO disable option (per CONTEXT.md: 2FA cannot be disabled once enabled)
       - For OAuth-only users: show a note that they need to set a password first before enabling 2FA (Better Auth requires password to enable 2FA). Include a "Set Password" form that uses Better Auth's change password / set password API.

    7. Create `components/two-factor/setup-dialog.tsx`:
       - Modal/dialog that walks user through 2FA setup
       - Step 1: Call authClient.twoFactor.enable({ password }) -- user enters their password to confirm
       - Step 2: Display QR code (use `qrcode` package to render the TOTP URI as a data URL image) and manual entry key
       - Step 3: User enters a verification code from their authenticator app to confirm setup
       - Step 4: Display backup codes (components/two-factor/backup-codes.tsx)

    8. Create `components/two-factor/backup-codes.tsx`:
       - Display recovery codes in a grid
       - "Copy all" button to copy codes to clipboard
       - Checkbox: "I have saved these codes in a safe place" -- must be checked before proceeding
       - Warning text: "These codes will not be shown again"
       - "Done" button (disabled until checkbox checked) closes the dialog
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Auth page shows Google and Twitter OAuth buttons above email form with "or" divider
    - Clicking Google button redirects to Google OAuth (if env vars configured)
    - Settings page shows 2FA enable option
    - 2FA setup dialog shows QR code after password entry
    - After enabling 2FA, login flow redirects to /auth/2fa for code entry
    - 2FA cannot be disabled from settings (no disable button)
    - Backup codes shown once during setup
  </verify>
  <done>
    OAuth login works for Google and Twitter. 2FA can be enabled from settings with QR code setup, backup codes shown once, and 2FA is permanent (no disable). Login flow routes through 2FA verification when enabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: SOL withdrawal flow with address book and 2FA enforcement</name>
  <files>
    lib/solana/transfer.ts
    app/(dashboard)/dashboard/withdraw/page.tsx
    app/(dashboard)/dashboard/withdraw/review/page.tsx
    components/withdraw/withdraw-form.tsx
    components/withdraw/address-book.tsx
    components/withdraw/review-card.tsx
  </files>
  <action>
    1. Create `lib/solana/transfer.ts`:
       - buildAndSendSolTransfer(userId: string, toAddress: string, amountLamports: bigint): Promise<{ signature: string; fee: bigint }>
       - Fetch user's wallet from DB, decrypt private key using decryptPrivateKey()
       - Reconstruct a KeyPairSigner from the raw private key bytes using @solana/kit
         NOTE: This is the tricky part per research open question. Use @solana/keys createKeyPairFromBytes() or equivalent to create a CryptoKeyPair from raw Ed25519 bytes, then wrap with createSignerFromKeyPair(). If @solana/keys doesn't expose this directly, use Node.js crypto to create a CryptoKey from raw bytes and construct the signer manually. Test this carefully.
       - Build transaction using pipe() pattern from research: createTransactionMessage -> setFeePayer -> setLifetimeUsingBlockhash -> appendInstruction(getTransferSolInstruction)
       - Sign and send via RPC
       - Record withdrawal in the withdrawals table (status: "pending", with txSignature)
       - Return { signature, fee } where fee is the estimated network fee

    2. Create server actions for withdrawal operations (in a file like `lib/actions/withdraw.ts` or colocated):
       - `getWithdrawalData(userId)` -- fetch wallet balance, saved addresses
       - `saveAddress(userId, address, label)` -- save to savedAddress table
       - `deleteAddress(userId, addressId)` -- remove saved address
       - `executeWithdrawal(userId, toAddress, amountLamports, totpCode)` -- verify 2FA, then call buildAndSendSolTransfer
         - CRITICAL: Verify TOTP code server-side before executing the transfer
         - If user hasn't enabled 2FA yet, redirect to settings with a message "Enable 2FA to make withdrawals"

    3. Create `app/(dashboard)/dashboard/withdraw/page.tsx` (Step 1):
       - Fetch user's wallet balance and saved addresses server-side
       - Render withdraw-form component
       - Show current balance at top
       - If 2FA not enabled: show a banner/alert directing user to settings to enable 2FA first, disable the form

    4. Create `components/withdraw/withdraw-form.tsx`:
       - Destination address input (text input with Solana address validation -- 32-44 base58 chars)
       - OR select from address book (components/withdraw/address-book.tsx)
       - Amount input in SOL with "Max" button (sets to full balance minus estimated fee)
       - Show USD equivalent of amount as user types
       - "Save this address" checkbox with label input (when using new address)
       - "Continue to Review" button -- navigates to /dashboard/withdraw/review with data in URL params or form submission

    5. Create `components/withdraw/address-book.tsx`:
       - List of saved addresses with labels
       - Click to select (fills the address input)
       - Delete button per address (with confirmation)
       - "Add new address" option to switch back to manual input
       - Empty state if no saved addresses

    6. Create `app/(dashboard)/dashboard/withdraw/review/page.tsx` (Step 2):
       - Separate review page (per CONTEXT.md: two-step confirmation with separate review PAGE)
       - Shows: destination address, amount (SOL + USD), estimated network fee, final amount after fee
       - TOTP code input -- user must enter their 2FA code to confirm
       - "Confirm Withdrawal" button -- calls executeWithdrawal server action
       - On success: show transaction signature with link to Solana Explorer, redirect to dashboard after delay
       - On failure: show error, allow retry
       - "Back" link to go back to step 1

    7. Create `components/withdraw/review-card.tsx`:
       - Clean card layout showing all withdrawal details
       - Destination address (truncated middle with full on hover)
       - Amount in SOL and USD
       - Network fee estimate
       - Final amount = amount - fee
       - Visual separation between details and confirmation action

    Transaction status feedback (Claude's discretion per CONTEXT.md):
    - After submitting: show a loading state with "Submitting transaction..."
    - On confirmation: show success with green checkmark, tx signature as a clickable link to Solana Explorer (solscan.io or explorer.solana.com), and a "Back to Dashboard" button
    - On failure: show error with red warning, the error message, and a "Try Again" button
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - Withdrawal page shows balance and form
    - Without 2FA enabled: withdrawal page shows "enable 2FA first" banner
    - With 2FA enabled: can fill out form and navigate to review page
    - Review page shows all details including fee estimate
    - TOTP code required on review page to confirm
    - Successful withdrawal records transaction in database
    - Address book: can save, select, and delete addresses
  </verify>
  <done>
    Complete SOL withdrawal flow with two-step confirmation (details page -> review page), 2FA enforcement on every withdrawal, address book for saved addresses, and transaction status feedback. Users without 2FA are prompted to enable it before withdrawing.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 1: Authentication and Wallets system including:
    - Email/password signup and login with split-screen auth page
    - Google and Twitter OAuth login
    - TOTP 2FA setup and enforcement
    - Custodial Solana wallet auto-created on signup
    - Dashboard with wallet widget (USD/SOL balance, togglable address)
    - SOL withdrawal with two-step confirmation, address book, and 2FA requirement
  </what-built>
  <how-to-verify>
    1. Visit /auth -- verify split-screen layout (branding left, form right)
    2. Create account with email/password -- should redirect to /dashboard
    3. Verify wallet widget in sidebar shows $0.00 / 0 SOL
    4. Toggle wallet address visibility
    5. Go to /dashboard/settings -- enable 2FA
    6. Verify QR code appears, scan with authenticator app
    7. Verify backup codes are shown and must be acknowledged
    8. Log out and log back in -- verify 2FA prompt appears
    9. Enter 2FA code -- verify access to dashboard
    10. Go to /dashboard/withdraw -- verify form with address input and amount
    11. Fill in withdrawal details and proceed to review page
    12. Verify review page shows destination, amount, fee, and requires 2FA code
    13. Test OAuth buttons appear on auth page (functional test requires OAuth env vars)
    14. Test address book: save an address, select it, delete it
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Auth page: split-screen layout, OAuth buttons above email, "or" divider
2. Email signup: creates account + wallet, redirects to dashboard
3. OAuth signup: creates account + wallet (if env vars configured)
4. Dashboard: sidebar wallet widget, USD primary, SOL secondary, address toggle
5. Settings: 2FA enable flow with QR code, backup codes, permanent (no disable)
6. Login with 2FA: redirects to /auth/2fa, accepts TOTP code
7. Withdrawal: two-step flow, 2FA required, address book, transaction confirmation
8. Withdrawal without 2FA: blocked with "enable 2FA" prompt
9. Database: wallet rows have encrypted_private_key in correct format
10. Database: withdrawal rows recorded with tx signature and status
</verification>

<success_criteria>
- AUTH-01: Email/password signup and login works
- AUTH-02: Google and Twitter OAuth buttons present and functional (with env vars)
- AUTH-03: TOTP 2FA can be enabled, is enforced on login and withdrawal, cannot be disabled
- AUTH-04: Wallet created automatically on signup (verified in DB)
- AUTH-05: Private keys AES-256-GCM encrypted in database
- AUTH-06: SOL balance and USD equivalent visible in dashboard wallet widget
- AUTH-07: SOL withdrawal to external address with 2FA confirmation works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/01-authentication-wallets/01-03-SUMMARY.md`
</output>
