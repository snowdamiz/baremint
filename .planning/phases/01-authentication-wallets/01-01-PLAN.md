---
phase: 01-authentication-wallets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - drizzle.config.ts
  - lib/db/index.ts
  - lib/db/schema.ts
  - lib/auth.ts
  - lib/auth-client.ts
  - lib/env.ts
  - app/api/auth/[...all]/route.ts
  - app/(auth)/auth/page.tsx
  - app/(auth)/layout.tsx
  - app/layout.tsx
  - app/globals.css
  - components/auth/auth-form.tsx
  - components/ui/*
  - proxy.ts
  - .env.example
autonomous: true

must_haves:
  truths:
    - "User can create an account with email and password"
    - "User can log in with email and password across browser sessions"
    - "Unauthenticated users are redirected to /auth when accessing /dashboard"
    - "Authenticated users see a dashboard page after login"
  artifacts:
    - path: "lib/db/schema.ts"
      provides: "User, session, account, verification tables for Better Auth"
      contains: "pgTable"
    - path: "lib/auth.ts"
      provides: "Better Auth server instance with Drizzle adapter"
      exports: ["auth"]
    - path: "lib/auth-client.ts"
      provides: "Better Auth client instance"
      exports: ["authClient"]
    - path: "app/api/auth/[...all]/route.ts"
      provides: "Better Auth catch-all route handler"
      exports: ["GET", "POST"]
    - path: "app/(auth)/auth/page.tsx"
      provides: "Unified auth page with split-screen layout"
    - path: "proxy.ts"
      provides: "Route protection for dashboard routes"
  key_links:
    - from: "components/auth/auth-form.tsx"
      to: "lib/auth-client.ts"
      via: "authClient.signIn.email / authClient.signUp.email"
      pattern: "authClient\\.sign"
    - from: "lib/auth.ts"
      to: "lib/db/index.ts"
      via: "drizzleAdapter(db)"
      pattern: "drizzleAdapter"
    - from: "app/api/auth/[...all]/route.ts"
      to: "lib/auth.ts"
      via: "toNextJsHandler(auth)"
      pattern: "toNextJsHandler"
    - from: "proxy.ts"
      to: "better-auth/cookies"
      via: "getSessionCookie"
      pattern: "getSessionCookie"
---

<objective>
Set up the database, ORM, and authentication system so users can create accounts with email/password and log in across browser sessions.

Purpose: This is the foundation everything else builds on -- database connection, schema, Better Auth with Drizzle adapter, auth UI, and route protection.
Output: Working email/password auth with split-screen auth page, session persistence, and protected dashboard route.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-authentication-wallets/01-RESEARCH.md
@.planning/phases/01-authentication-wallets/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, configure database, and create schema</name>
  <files>
    package.json
    drizzle.config.ts
    lib/db/index.ts
    lib/db/schema.ts
    lib/env.ts
    .env.example
  </files>
  <action>
    1. Install all Phase 1 dependencies:
       ```bash
       npm install better-auth drizzle-orm @neondatabase/serverless @solana/kit helius-sdk zod qrcode @t3-oss/env-nextjs
       npm install -D drizzle-kit @types/qrcode
       ```
       Note: Install ALL Phase 1 deps now (including Solana/wallet ones) so later plans don't need to touch package.json.

    2. Initialize shadcn/ui:
       ```bash
       npx shadcn@latest init -d
       ```
       Then add needed components:
       ```bash
       npx shadcn@latest add button input label card separator tabs toast
       ```

    3. Create `lib/env.ts` using @t3-oss/env-nextjs with zod validation:
       - DATABASE_URL (string, required)
       - BETTER_AUTH_SECRET (string, required)
       - BETTER_AUTH_URL (string, url, required)
       - GOOGLE_CLIENT_ID (string, optional -- needed in Plan 03)
       - GOOGLE_CLIENT_SECRET (string, optional)
       - TWITTER_CLIENT_ID (string, optional)
       - TWITTER_CLIENT_SECRET (string, optional)
       - WALLET_ENCRYPTION_KEY (string, optional -- needed in Plan 02)
       - HELIUS_RPC_URL (string, optional -- needed in Plan 03)
       - NEXT_PUBLIC_APP_URL (string, required)

    4. Create `lib/db/index.ts` -- Drizzle client with Neon serverless driver. Use the pattern from research:
       ```typescript
       import { neon } from "@neondatabase/serverless";
       import { drizzle } from "drizzle-orm/neon-http";
       import * as schema from "./schema";
       const sql = neon(process.env.DATABASE_URL!);
       export const db = drizzle({ client: sql, schema });
       ```

    5. Create `lib/db/schema.ts` with ALL tables needed for Phase 1:
       - Better Auth tables: user, session, account, verification, twoFactor (include twoFactor now so Plan 03 doesn't need schema changes)
       - Custom tables: wallet, savedAddress, withdrawal
       - Use the exact schema from research. Include all fields.
       - Export all tables.

    6. Create `drizzle.config.ts` pointing to lib/db/schema.ts, dialect "postgresql", dbCredentials from DATABASE_URL env var.

    7. Create `.env.example` with all env vars (empty values) and comments explaining each.

    8. Run `npx drizzle-kit generate` to generate initial migration, then `npx drizzle-kit push` to push schema to the database.
       NOTE: This requires DATABASE_URL to be set. If not available, just generate the migration and note that push needs to happen when DB is configured.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - `drizzle.config.ts` exists and references correct schema path
    - `lib/db/schema.ts` exports user, session, account, verification, twoFactor, wallet, savedAddress, withdrawal tables
    - `.env.example` lists all required env vars
  </verify>
  <done>
    Database client configured with Neon driver, full schema defined with all Phase 1 tables (including wallet/withdrawal for later plans), migrations generated, shadcn/ui initialized with base components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Set up Better Auth, route handler, proxy, and auth UI</name>
  <files>
    lib/auth.ts
    lib/auth-client.ts
    app/api/auth/[...all]/route.ts
    app/(auth)/auth/page.tsx
    app/(auth)/layout.tsx
    app/(dashboard)/dashboard/page.tsx
    app/(dashboard)/layout.tsx
    app/layout.tsx
    app/globals.css
    components/auth/auth-form.tsx
    proxy.ts
  </files>
  <action>
    1. Create `lib/auth.ts` -- Better Auth server instance:
       - drizzleAdapter with provider "pg"
       - emailAndPassword enabled
       - twoFactor plugin configured (issuer "Baremint", 6 digits, 30s period, 10 backup codes of length 10) -- configure now so Plan 03 just enables OAuth providers
       - nextCookies() as LAST plugin (critical -- see pitfall in research)
       - Do NOT add socialProviders yet (Plan 03 handles that)
       - trustedOrigins if needed

    2. Create `lib/auth-client.ts` -- Better Auth client:
       ```typescript
       import { createAuthClient } from "better-auth/react";
       import { twoFactorClient } from "better-auth/client/plugins";
       export const authClient = createAuthClient({
         plugins: [twoFactorClient({ onTwoFactorRedirect() { window.location.href = "/auth/2fa"; } })],
       });
       ```

    3. Create `app/api/auth/[...all]/route.ts`:
       ```typescript
       import { auth } from "@/lib/auth";
       import { toNextJsHandler } from "better-auth/next-js";
       export const { GET, POST } = toNextJsHandler(auth);
       ```

    4. Create `proxy.ts` at project root (NOT middleware.ts -- Next.js 16 uses proxy):
       - Import getSessionCookie from "better-auth/cookies"
       - Check for session cookie, redirect to /auth if missing
       - matcher: ["/dashboard/:path*"]

    5. Create auth page with split-screen layout per CONTEXT.md decisions:
       - `app/(auth)/layout.tsx` -- minimal layout for auth routes
       - `app/(auth)/auth/page.tsx` -- split-screen: left side branding (Baremint logo, tagline, dark background), right side auth form
       - Left side: dark background with centered branding content. Baremint name, brief tagline about creator tokens. Claude's discretion on exact copy.
       - Right side: white/light background with the auth form component centered

    6. Create `components/auth/auth-form.tsx` -- unified email-first auth form:
       - Email input field at top
       - On email submit: call Better Auth to check if account exists
       - If exists: show password field for login
       - If new: show password + confirm password fields for signup
       - Use authClient.signIn.email() and authClient.signUp.email()
       - On success: redirect to /dashboard
       - Show validation errors inline
       - OAuth buttons placeholder area above email (will be wired in Plan 03) -- for now just show the "or" divider with a comment

    7. Create dashboard placeholder:
       - `app/(dashboard)/layout.tsx` -- basic layout with sidebar placeholder and main content area
       - `app/(dashboard)/dashboard/page.tsx` -- simple page showing "Welcome to Baremint" and user email from session
       - Fetch session server-side using auth.api.getSession({ headers: await headers() })
       - If no session, redirect to /auth

    8. Update `app/layout.tsx` to include Toaster from shadcn/ui for notifications.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds (or `npm run dev` starts without errors)
    - Auth page renders at /auth with split-screen layout
    - proxy.ts redirects unauthenticated users from /dashboard to /auth
    - After creating account with email/password, user lands on /dashboard
    - After logging out and logging back in, session persists
  </verify>
  <done>
    Users can create accounts with email/password, log in, see a dashboard page, and are redirected to /auth when unauthenticated. Split-screen auth UI matches the design decisions from CONTEXT.md. Sessions persist across browser sessions.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /dashboard unauthenticated -- should redirect to /auth
2. Auth page shows split-screen layout (branding left, form right)
3. Enter new email -- form shows password + confirm password fields
4. Create account -- redirected to /dashboard showing welcome message
5. Close browser, reopen /dashboard -- session persists, still authenticated
6. Enter existing email -- form shows only password field
7. Log in with correct password -- redirected to /dashboard
8. Log in with wrong password -- shows error message
</verification>

<success_criteria>
- Email/password signup and login work end-to-end
- Sessions persist across browser restarts
- Route protection via proxy.ts redirects unauthenticated users
- Database schema includes all Phase 1 tables (user, session, account, verification, twoFactor, wallet, savedAddress, withdrawal)
- Auth page uses split-screen layout per design decisions
</success_criteria>

<output>
After completion, create `.planning/phases/01-authentication-wallets/01-01-SUMMARY.md`
</output>
